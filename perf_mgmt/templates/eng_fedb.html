<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Experience Portal</title>
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            /* Light Mode Variables */
            --primary: #1ABB9C; /* Teal */
            --secondary: #2A3F54; /* Deep navy */
            --accent: #34D399; /* Lighter teal */
            --text: #1E293B; /* Slate-800 */
            --bg: #F1F5F9; /* Slate-100 */
            --surface: #FFFFFF;
            --border: #E2E8F0; /* Slate-200 */
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --modal-bg: #FFFFFF;
            --modal-overlay: rgba(15, 23, 42, 0.85);
            --input-bg: #F8FAFC; /* Slate-50 */
            --gradient: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            --tile1-bg: linear-gradient(135deg, #E6F7FA 0%, #B2E3E8 100%);
            --tile2-bg: linear-gradient(135deg, #E6FFE6 0%, #B2E8B2 100%);
            --tile3-bg: linear-gradient(135deg, #FFF7E6 0%, #E8DAB2 100%);
            --tile4-bg: linear-gradient(135deg, #F5F9FF 0%, #C2D4FF 100%);
            --card1-bg: linear-gradient(135deg, #E6F7FA 0%, #B2E3E8 100%);
            --card2-bg: linear-gradient(135deg, #E6FFE6 0%, #B2E8B2 100%);
            --card3-bg: linear-gradient(135deg, #FFF7E6 0%, #E8DAB2 100%);
            --text-secondary: #64748B; /* Slate-500 */
        }

        [data-theme="dark"] {
            /* Dark Mode Variables */
            --text: #F1F5F9; /* Slate-100 */
            --bg: #1E293B; /* Slate-800 */
            --surface: #2D3748; /* Slate-700 */
            --border: #4B5563; /* Slate-600 */
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            --modal-bg: #2D3748; /* Slate-700 */
            --modal-overlay: rgba(0, 0, 0, 0.9);
            --input-bg: #374151; /* Slate-600 */
            --tile1-bg: linear-gradient(135deg, #2C6B7F 0%, #1A4B5A 100%);
            --tile2-bg: linear-gradient(135deg, #2C7F2C 0%, #1A5A1A 100%);
            --tile3-bg: linear-gradient(135deg, #7F6B2C 0%, #5A4B1A 100%);
            --tile4-bg: linear-gradient(135deg, #2C4B7F 0%, #1A3B5A 100%);
            --card1-bg: linear-gradient(135deg, #2C6B7F 0%, #1A4B5A 100%);
            --card2-bg: linear-gradient(135deg, #2C7F2C 0%, #1A5A1A 100%);
            --card3-bg: linear-gradient(135deg, #7F6B2C 0%, #5A4B1A 100%);
            --text-secondary: #94A3B8; /* Slate-400 */
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Merriweather', serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
            font-size: 0.875rem;
            transition: background 0.3s ease, color 0.3s ease;
        }

        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background: radial-gradient(circle at 10% 20%, rgba(26, 187, 156, 0.1) 0%, transparent 50%),
                        radial-gradient(circle at 90% 80%, rgba(42, 63, 84, 0.1) 0%, transparent 50%);
            animation: pulseBackground 15s ease-in-out infinite;
            z-index: -1;
        }

        @keyframes pulseBackground {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 0.8; }
        }

        /* Navigation */
        .performa-nav {
            background: var(--gradient);
            padding: 1rem 2rem;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-radius: 0 0 12px 12px;
        }

        .logo-container {
            width: 55px;
            height: 46px;
            background: url('/static/admin/img/pmh_3.png') no-repeat center/cover;
            border-radius: 8px;
            border: 2px solid #FFFFFF;
            box-shadow: 0 0 10px rgba(26, 187, 156, 0.5);
            transition: transform 0.3s ease;
        }

        .logo-container:hover {
            transform: scale(1.1);
        }

        .main-title {
            font-size: 1.75rem;
            font-weight: 700;
            margin: 0;
            flex-grow: 1;
            text-align: center;
        }

        .gradient-text {
            background: var(--gradient);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .nav-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .gatekeeper {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #FFFFFF;
        }

        .gatekeeper span {
            font-size: 0.875rem;
            font-weight: 600;
        }

        .nav-input {
            padding: 0.5rem;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: #FFFFFF;
            border-radius: 6px;
            font-size: 0.875rem;
            width: 120px;
            transition: background 0.3s ease, box-shadow 0.3s ease;
        }

        .nav-input:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.2);
            box-shadow: 0 0 8px rgba(26, 187, 156, 0.3);
        }

        .nav-input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .logout-btn, .theme-toggle {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            padding: 0.5rem;
            border-radius: 8px;
            color: #FFFFFF;
            cursor: pointer;
            transition: background 0.3s ease, transform 0.3s ease;
        }

        .logout-btn:hover, .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        /* Glass Container */
        .glass-container {
            max-width: 1200px;
            margin: 2rem auto;
            background: linear-gradient(145deg, var(--surface) 0%, rgba(255, 255, 255, 0.75) 100%);
            backdrop-filter: blur(15px);
            border-radius: 1.5rem;
            box-shadow: var(--shadow);
            padding: 2rem;
            position: relative;
            overflow: hidden;
        }

        [data-theme="dark"] .glass-container {
            background: linear-gradient(145deg, var(--surface) 0%, rgba(45, 55, 72, 0.75) 100%);
        }

        .glass-container::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(45deg, 
                rgba(26, 187, 156, 0.05) 0%,
                rgba(42, 63, 84, 0.05) 50%,
                rgba(52, 211, 153, 0.05) 100%);
            animation: shimmer 10s linear infinite;
            z-index: -1;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        /* Form */
        #my-form {
            display: none; /* Hidden by default */
            background: var(--surface);
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: var(--shadow);
            margin: 2rem auto;
            max-width: 600px;
        }

        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            justify-content: center;
        }

        .field-container {
            flex: 1;
            min-width: 150px;
        }

        .field-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text);
            margin-bottom: 0.25rem;
        }

        .input-small {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--input-bg);
            color: var(--text);
            font-size: 0.875rem;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .input-small:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 4px rgba(26, 187, 156, 0.3);
        }

        .checkbox-label {
            font-size: 0.875rem;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        /* Tile Container */
        .tile-container {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin: 2rem 0;
            padding: 1rem;
            background: var(--gradient);
            border-radius: 12px;
            box-shadow: var(--shadow);
        }

        .tile1, .tile2, .tile3, .tile4 {
            width: 250px;
            min-height: 220px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: var(--surface);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            overflow: hidden;
            animation: fadeInQuote 1s ease-out forwards;
        }

        .tile1 { background: var(--tile1-bg); }
        .tile2 { background: var(--tile2-bg); }
        .tile3 { background: var(--tile3-bg); }
        .tile4 { background: var(--tile4-bg); }

        .tile1:hover, .tile2:hover, .tile3:hover, .tile4:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }

        .tile1::before, .tile2::before, .tile3::before, .tile4::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--gradient);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .tile1:hover::before, .tile2:hover::before, .tile3:hover::before, .tile4:hover::before {
            opacity: 1;
        }

        .quote1, .quote2, .quote3, .quote4 {
            font-size: 0.9rem;
            font-style: italic;
            color: var(--text);
            text-align: center;
            margin: 0.5rem 0;
            line-height: 1.4;
            position: relative;
            padding: 0.5rem;
        }

        .quote1::before, .quote2::before, .quote3::before, .quote4::before {
            content: '“';
            font-size: 2rem;
            color: var(--primary);
            position: absolute;
            top: -0.5rem;
            left: 0;
            opacity: 0.5;
        }

        .quote1::after, .quote2::after, .quote3::after, .quote4::after {
            content: '”';
            font-size: 2rem;
            color: var(--primary);
            position: absolute;
            bottom: -1rem;
            right: 0;
            opacity: 0.5;
        }

        .author {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--primary);
            text-align: center;
            margin-top: 0.5rem;
        }

        @keyframes fadeInQuote {
            0% { opacity: 0; transform: translateY(10px); }
            100% { opacity: 1; transform: translateY(0); }
        }

        /* Topic Grid */
        .topic-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 2rem;
            padding: 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        .topic-card {
            position: relative;
            background: var(--surface);
            border-radius: 15px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .topic-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
        }

        .topic-card:nth-child(1) { background: var(--card1-bg); }
        .topic-card:nth-child(2) { background: var(--card2-bg); }
        .topic-card:nth-child(3) { background: var(--card3-bg); }

        .topic-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            transition: transform 0.3s ease;
        }

        .topic-card:hover .topic-icon {
            transform: scale(1.2) rotate(-5deg);
        }

        .topic-card h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 0.5rem;
        }

        .topic-card p {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin: 0;
        }

        .hover-effect {
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(120deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.8s ease;
        }

        [data-theme="dark"] .hover-effect {
            background: linear-gradient(120deg, transparent, rgba(0, 0, 0, 0.3), transparent);
        }

        .topic-card:hover .hover-effect {
            left: 100%;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: var(--modal-overlay);
            backdrop-filter: blur(5px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .modal-content {
            background: var(--modal-bg);
            border-radius: 1.5rem;
            padding: 1.5rem;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow);
            transform: scale(0.8);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .modal-overlay.active .modal-content {
            transform: scale(1);
            opacity: 1;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--gradient);
            padding: 1rem;
            border-radius: 12px 12px 0 0;
            color: #FFFFFF;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #FFFFFF;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .modal-close:hover {
            color: var(--accent);
        }

        .modal-body {
            padding: 1.5rem;
        }

        .factor-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .factor-type {
            padding: 0.5rem 1rem;
            background: var(--input-bg);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            color: var(--text);
            transition: background 0.3s ease;
        }

        .factor-type:hover {
            background: var(--primary);
            color: #FFFFFF;
        }

        .question-container {
            background: var(--input-bg);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            box-shadow: var(--shadow);
        }

        .question-text {
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
            color: var(--text);
        }

        .rating-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .rating-btn {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--surface);
            color: var(--text);
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.3s ease;
        }

        .rating-btn:hover {
            background: var(--primary);
            color: #FFFFFF;
            border-color: var(--primary);
        }

        .rating-btn.selected-rating {
            background: var(--primary);
            color: #FFFFFF;
            border-color: var(--primary);
        }

        .feedback-input {
            width: 100%;
            height: 120px;
            padding: 1rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--input-bg);
            color: var(--text);
            resize: none;
            font-size: 0.875rem;
            transition: border-color 0.3s ease;
        }

        .feedback-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 4px rgba(26, 187, 156, 0.3);
        }

        .submit-btn {
            background: var(--gradient);
            color: #FFFFFF;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-top: 1rem;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(26, 187, 156, 0.3);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .performa-nav {
                padding: 1rem;
                flex-direction: column;
                gap: 1rem;
            }

            .main-title {
                font-size: 1.5rem;
            }

            .nav-controls {
                flex-direction: column;
                align-items: flex-end;
            }

            .glass-container {
                margin: 1rem;
                padding: 1.5rem;
                border-radius: 1rem;
            }

            .tile-container {
                flex-direction: column;
                align-items: center;
            }

            .tile1, .tile2, .tile3, .tile4 {
                width: 100%;
                max-width: 300px;
                min-height: 200px;
            }

            .quote1, .quote2, .quote3, .quote4 {
                font-size: 0.85rem;
            }

            .author {
                font-size: 0.8rem;
            }

            .topic-grid {
                grid-template-columns: 1fr;
                padding: 1rem;
            }

            .modal-content {
                width: 95%;
                padding: 1rem;
            }
        }

        @media (max-width: 480px) {
            .main-title {
                font-size: 1.25rem;
            }

            .nav-input {
                width: 100px;
                font-size: 0.75rem;
            }

            .tile1, .tile2, .tile3, .tile4 {
                min-height: 180px;
            }

            .quote1, .quote2, .quote3, .quote4 {
                font-size: 0.8rem;
            }

            .author {
                font-size: 0.75rem;
            }

            .submit-btn {
                padding: 0.5rem 1rem;
                font-size: 0.875rem;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="performa-nav">
        <h1 class="main-title">
            <span class="gradient-text" style="margin-left: -650px;">Experience Pulse</span>
        </h1>
        <div class="nav-controls">
            <div class="gatekeeper">
                <span>Welcome</span>
                <input type="text" id="username" class="nav-input" style="width: 110%; background-color: transparent;" readonly>
            </div>
            <button class="theme-toggle" onclick="toggleTheme()" title="Toggle Theme" aria-label="Toggle between light and dark mode">
                <i class="fas fa-moon"></i>
            </button>
            <a href="http://127.0.0.1:8002/employee-appraisal/?username=#" class="fixed top-1 right-1 z-50 group">
                <div class="glass-panel p-3 rounded-xl flex items-center space-x-2 hover:scale-105 transition-transform">
                    <i class="fa fa-home text-cyan-300 group-hover:text-cyan-200 transition-colors" style="color: white;"></i>
                </div>
            </a>
        </div>
    </nav>

    <!-- Form (Hidden) -->
    <form id="my-form" style="display: none !important;">
        <div class="form-row">
            <div class="field-container">
                <label class="field-label" for="username">Employee Name:</label>
                <input class="input-small" type="text" id="username" name="username" placeholder="Name">
            </div>
            <div class="field-container">
                <label class="field-label" for="employee-password">Password:</label>
                <input class="input-small" type="password" id="employee-password" name="employee_password" placeholder="Password">
                <label class="checkbox-label">
                    <input type="checkbox" id="show-password"> Show
                </label>
            </div>
            <div class="field-container">
                <label class="field-label" for="company_code">Company Code:</label>
                <input class="input-small" type="text" id="company_code" name="company_code" placeholder="Company Code">
            </div>
            <div class="field-container">
                <label class="field-label" for="branch_code">Branch Code:</label>
                <input class="input-small" type="text" id="branch_code" name="branch_code" placeholder="Branch Code">
            </div>
            <div class="field-container">
                <label class="field-label" for="region_branch">Region Branch:</label>
                <input class="input-small" type="text" id="region_branch" name="region_branch" placeholder="Region Branch">
            </div>
        </div>
    </form>

    <!-- Glass Container -->
    <div class="glass-container">
        <!-- Tile Container -->
        <div class="tile-container">
            <div class="tile1">
                <p class="quote1">Take care of your employees, and they'll take care of your business.</p>
                <p class="author">Richard Branson</p>
            </div>
            <div class="tile2">
                <p class="quote2">Culture eats strategy for breakfast. A positive workplace culture drives performance.</p>
                <p class="author">Peter Drucker</p>
            </div>
            <div class="tile3">
                <p class="quote3">When employees feel valued as people, they become more productive and engaged.</p>
                <p class="author">Anne M. Mulcahy</p>
            </div>
            <div class="tile4">
                <p class="quote4">To win in the marketplace, you must first win in the workplace.</p>
                <p class="author">Doug Conant</p>
            </div>
        </div>

        <!-- Topic Grid -->
        <div class="topic-grid">
            <div class="topic-card" onclick="openModal(1)">
                <i class="fas fa-smile-beam topic-icon"></i>
                <h3>Job Satisfaction</h3>
                <p>Evaluate your work fulfillment and engagement levels</p>
                <div class="hover-effect"></div>
            </div>
            <div class="topic-card" onclick="openModal(3)">
                <i class="fas fa-balance-scale topic-icon"></i>
                <h3>Work-Life Balance</h3>
                <p>Measure your equilibrium between professional and personal life</p>
                <div class="hover-effect"></div>
            </div>
            <div class="topic-card" onclick="openModal(4)">
                <i class="fas fa-seedling topic-icon"></i>
                <h3>Growth & Development</h3>
                <p>Evaluate learning opportunities and career progression</p>
                <div class="hover-effect"></div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal-overlay" id="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Job Satisfaction Survey</h2>
                <button class="modal-close" onclick="closeModal()" aria-label="Close modal">×</button>
            </div>
            <div class="modal-body">
                <div class="factor-container"></div>
                <div class="rating-system" id="questions-container"></div>
                <textarea class="feedback-input" placeholder="Share your thoughts..."></textarea>
                <button class="submit-btn" onclick="submitExperienceFeedback()">Submit Feedback</button>
            </div>
        </div>
    </div>

    <script>
        // Theme Toggle
        function toggleTheme() {
            const html = document.documentElement;
            const themeToggle = document.querySelector('.theme-toggle i');
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            
            html.setAttribute('data-theme', newTheme);
            themeToggle.className = newTheme === 'light' ? 'fas fa-moon' : 'fas fa-sun';
            localStorage.setItem('theme', newTheme);
        }

        // Apply saved theme on load
        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            const themeToggle = document.querySelector('.theme-toggle i');
            themeToggle.className = savedTheme === 'light' ? 'fas fa-moon' : 'fas fa-sun';
        });

        // Username Population
        window.onload = function() {
            let username = localStorage.getItem('username');
            document.querySelectorAll('#username').forEach(input => {
                input.value = username;
            });
            fetchAndPopulateCompanyCode(username);
        };

        // Fetch Company Code
        function fetchAndPopulateCompanyCode(username) {
            if (username && username.length > 2) {
                fetch(`/seek_company_code/?username=${encodeURIComponent(username)}`)
                    .then(response => response.json())
                    .then(data => {
                        const companyCodeInput = document.getElementById('company_code');
                        if (data.company_code) {
                            companyCodeInput.value = data.company_code;
                            fetchMatchingValues(data.company_code);
                            fetchRegionBranch(data.company_code, username);
                        } else {
                            companyCodeInput.value = '';
                        }
                    })
                    .catch(error => {
                        console.error('Company code fetch error:', error);
                    });
            }
        }

        // Fetch Region Branch
        function fetchRegionBranch(companyCode, employeeCode) {
            if (!companyCode || !employeeCode) {
                document.getElementById('branch_code').value = '';
                document.getElementById('region_branch').value = '';
                return;
            }
            fetch(`/get-region-branch/?company_code=${encodeURIComponent(companyCode)}&employee_code=${encodeURIComponent(employeeCode)}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('branch_code').value = data.region_code || '';
                    document.getElementById('region_branch').value = data.region_branch || '';
                })
                .catch(error => {
                    console.error('Error fetching region data:', error);
                });
        }

        // Password Toggle
        function handleShowPasswordToggle(e) {
            const passwordInput = document.getElementById('employee-password');
            passwordInput.type = e.target.checked ? 'text' : 'password';
        }

        document.addEventListener('DOMContentLoaded', () => {
            const toggle = document.getElementById('show-password');
            if (toggle) toggle.addEventListener('change', handleShowPasswordToggle);
            document.getElementById('employee-password').addEventListener('input', fetchCompanyCode);
        });

        function fetchCompanyCode() {
            const employeeCode = document.getElementById('employee-password').value.trim();
            if (!employeeCode) {
                document.getElementById('company_code').value = '';
                return;
            }
            fetch(`/get_company_code/?employee_code=${encodeURIComponent(employeeCode)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.company_code) {
                        document.getElementById('company_code').value = data.company_code;
                        fetchRegionBranch(data.company_code, employeeCode);
                    } else {
                        document.getElementById('company_code').value = '';
                    }
                })
                .catch(error => {
                    console.error('Fetch error:', error);
                });
        }

        // Logout
        function handleLogout() {
            if (confirm('Are you sure you want to log out?')) {
                fetch('/logout/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json'
                    }
                })
                    .then(response => {
                        if (response.ok) {
                            window.location.href = "{% url 'main' %}";
                        } else {
                            console.error('Logout failed:', response.statusText);
                        }
                    })
                    .catch(error => {
                        console.error('Logout error:', error);
                    });
            }
        }

        // Modal Functions
        let factorTypes = [];
        function fetchMatchingValuesExperience(companyCode) {
            fetch(`http://127.0.0.1:8002/fetch_matching_values_experience/?company_code=${companyCode}`)
                .then(response => response.json())
                .then(data => {
                    factorTypes = data.map(item => item.factor_type);
                    populateExperienceModal(data);
                    attachExperienceModalListeners();
                })
                .catch(error => console.error('Error:', error));
        }

        function populateExperienceModal(data) {
            const modal = document.getElementById('modal');
            const content = modal.querySelector('.modal-content');
            content.innerHTML = `
                <div class="modal-header">
                    <h2 class="modal-title">Job Satisfaction Survey</h2>
                    <button class="modal-close" onclick="closeModal()" aria-label="Close modal">×</button>
                </div>
                <div class="modal-body">
                    <div class="factor-container">
                        ${data.map((item, index) => `
                            <div class="factor-type" data-index="${index}">
                                ${item.factor_type}
                            </div>
                        `).join('')}
                    </div>
                    <div class="rating-system" id="questions-container"></div>
                    <textarea class="feedback-input" placeholder="Share your thoughts..."></textarea>
                    <button class="submit-btn" onclick="submitExperienceFeedback()">Submit Feedback</button>
                </div>
            `;
            modal.classList.add('active');
        }

        function openModal(id) {
            const companyCode = "CMP45678"; // Replace with dynamic value
            fetchMatchingValuesExperience(companyCode);
            const modal = document.getElementById('modal');
            modal.style.display = 'flex';
            setTimeout(() => {
                modal.classList.add('active');
            }, 10);
        }

        function closeModal() {
            const modal = document.getElementById('modal');
            modal.classList.remove('active');
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);
        }

        function attachExperienceModalListeners() {
            document.getElementById('modal').addEventListener('click', async (e) => {
                if (e.target.closest('.factor-type')) {
                    const companyCode = "CMP45678";
                    const index = e.target.getAttribute('data-index');
                    const selectedFactor = factorTypes[index];
                    const questionsContainer = document.getElementById('questions-container');
                    try {
                        const response = await fetch(
                            `http://127.0.0.1:8002/get_factor_description_exprience/?company_code=${companyCode}&factor_type=${encodeURIComponent(selectedFactor)}`
                        );
                        const data = await response.json();
                        questionsContainer.innerHTML = data.descriptions?.length > 0 ? data.descriptions.map((desc, idx) => `
                            <div class="question-container">
                                <p class="question-text">${idx + 1}. ${desc}</p>
                                <div class="rating-container">
                                    ${Array.from({length: 10}, (_, i) => `
                                        <button class="rating-btn" 
                                            data-question-index="${idx}"
                                            data-rating="${i + 1}"
                                            onclick="handleExperienceRating(${idx}, ${i + 1}, this)">
                                            ${i + 1}
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('') : '<p>No questions available for this factor.</p>';
                    } catch (error) {
                        console.error('Fetch error:', error);
                        questionsContainer.innerHTML = '<p>Error loading questions</p>';
                    }
                }
            });
        }

        function handleExperienceRating(questionIndex, rating, button) {
            const container = button.closest('.question-container');
            container.querySelectorAll('.rating-btn').forEach(btn => {
                btn.classList.remove('selected-rating');
                btn.textContent = btn.getAttribute('data-rating');
            });
            button.classList.add('selected-rating');
            button.textContent = `Selected: ${rating}`;
        }

        function submitExperienceFeedback() {
            const ratings = Array.from(document.querySelectorAll('#modal .selected-rating'));
            const feedback = document.querySelector('#modal .feedback-input').value;
            console.log('Saving experience feedback:', { ratings, feedback });
            closeModal();
        }

        window.onclick = function(e) {
            if (e.target === document.getElementById('modal')) {
                closeModal();
            }
        };
    </script>
</body>
</html>