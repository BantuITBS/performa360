<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Strategic Goal Metrics Map</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"></script>
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
</head>
    <style>
body {
    margin: 0;
    padding: 0;
    height: 100vh;
    width: 100vw;
    display: flex;
    flex-direction: column;
    background: linear-gradient(135deg, #0a0a0f, #121218);
    color: #e0e0e0;
    font-family: Arial, 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    font-size: 14px;
    overflow-y: auto !important;
    overflow-x: auto !important;
    margin-top: 55px;
}

body.no-scroll {
    overflow: auto;
}

body.light-theme {
    background: linear-gradient(135deg, #f5f7fa, #c3cfe2);
    color: #2c3e50;
}

#container {
    display: none; /* Changed to hide the container */
    position: relative;
    width: 100%;
    min-height: 100vh;
    overflow: visible;
    background-color: transparent !important;
}

.container {
    display: none; /* Added to hide any elements with class 'container' */
}

.node-strategic-goal {
    position: fixed;
    z-index: 999;
}

.node {
    position: absolute;
    background: rgba(15, 15, 25, 0.95);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.45);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    text-align: left;
    font-size: 12px;
    padding: 0;
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    min-width: 300px;
}

body.light-theme .node {
    background: rgba(255, 255, 255, 0.95);
}

.node-strategic-goal {
    height: 300px;
    border-color: #2ECC71;
    box-shadow: 0 0 15px rgba(46, 204, 113, 0.15);
}

.node-kpi,
.node-deliverable,
.node-document-evidence {
    height: 150px;
    padding: 4px 0;
}

.node-kpi {
    border-color: #3498db;
    box-shadow: 0 0 15px rgba(52, 152, 219, 0.15);
}

.node-deliverable {
    border-color: #E67E22;
    box-shadow: 0 0 15px rgba(230, 126, 34, 0.15);
}

.node-document-evidence {
    border-color: #9B59b6;
    box-shadow: 0 0 15px rgba(155, 142, 182, 0.15);
}

body.light-theme .node-strategic-goal {
    border-color: #27AE60;
    box-shadow: 0 0 15px rgba(39, 174, 96, 0.15);
}

body.light-theme .node-kpi {
    border-color: #1F618D;
    box-shadow: 0 0 15px rgba(31, 97, 141, 0.15);
}

body.light-theme .node-deliverable {
    border-color: #D35400;
    box-shadow: 0 0 15px rgba(211, 84, 0, 0.15);
}

body.light-theme .node-document-evidence {
    border-color: #8E44AD;
    box-shadow: 0 0 15px rgba(142, 68, 173, 0.15);
}

.node:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.6);
}

.node-content {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    word-wrap: break-word;
}

body.light-theme .node-content {
    background: #ffffff;
}

.node-header {
    padding: 10px 8px;
    background: linear-gradient(180deg, rgba(40, 40, 60, 0.9), rgba(30, 30, 45, 0.9));
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    font-size: 14px;
    letter-spacing: 0.5px;
    text-transform: uppercase;
    font-weight: 600;
    margin: 0;
    flex-shrink: 0;
    position: relative;
    text-align: left;
    white-space: normal;
    word-wrap: break-word;
    max-height: 4.5em;
    line-height: 1.5em;
    overflow: hidden;
}

.node-kpi .node-header,
.node-deliverable .node-header,
.node-document-evidence .node-header {
    margin-top: -20px;
}

body.light-theme .node-header {
    background: linear-gradient(180deg, #e0e0e0, #d0d0d0);
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
}

.node-number {
    position: absolute;
    top: 5px;
    right: 5px;
    font-size: 8px;
    opacity: 0.7;
    color: #e0e0e0;
}

body.light-theme .node-number {
    color: #2c3e50;
}

.node p {
    font-size: 12px;
    margin: 8px 0;
    word-wrap: break-word;
}

.node-form {
    padding: 10px;
    background: rgba(0, 0, 0, 0.3);
    border-top: 1px solid rgba(255, 255, 255, 0.1);
}

body.light-theme .node-form {
    background: rgba(255, 255, 255, 0.3);
    border-top: 1px solid rgba(0, 0, 0, 0.1);
}

.node-form select,
.node-form input {
    width: 100%;
    margin: 5px 0;
    padding: 6px;
    font-size: 11px;
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 6px;
    background: rgba(0, 0, 0, 0.5);
    color: white;
    box-sizing: border-box;
}

.node-form select {
    word-wrap: break-word;
    white-space: normal;
}

.node-form select option {
    word-wrap: break-word;
    white-space: normal;
    max-width: 280px;
}

.select2-container .select2-selection--single,
.select2-container .select2-selection--multiple {
    word-wrap: break-word;
    white-space: normal;
    max-width: 280px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid #2a2a3c;
    color: #00ffff;
    border-radius: 6px;
    font-size: 11px;
    height: auto;
    padding: 4px;
}

body.light-theme .select2-container .select2-selection--single,
body.light-theme .select2-container .select2-selection--multiple {
    background: #ffffff;
    color: #2c3e50;
    border-color: #ced4da;
}

.node-form select:hover,
.node-form input:hover {
    background: rgba(0, 0, 0, 0.7);
    border-color: rgba(255, 255, 255, 0.4);
}

body.light-theme .node-form select,
body.light-theme .node-form input {
    background: #ffffff;
    color: #2c3e50;
    border-color: #ced4da;
}

.node-footer {
    padding: 4px;
    background: rgba(0, 0, 0, 0.3);
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    flex-shrink: 0;
}

body.light-theme .node-footer {
    background: rgba(255, 255, 255, 0.3);
    border-top: 1px solid rgba(0, 0, 0, 0.1);
}

.button {
    background: linear-gradient(145deg, #00b4d8, #0077b6);
    color: white;
    border: none;
    padding: 4px;
    cursor: pointer;
    margin: 2px;
    font-size: 10px;
    transition: all 0.3s;
}

.button:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 180, 216, 0.3);
}

body.light-theme .button {
    color: #000000;
    border: 1px solid rgba(0, 0, 0, 0.2);
}

.edit-button {
    background: linear-gradient(145deg, #f1c40f, #e67e22);
}

.delete-button {
    background: linear-gradient(145deg, #e74c3c, #c0392b);
}

.label {
    font-size: 11px;
    opacity: 0.8;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: #00ffff;
    margin: 5px 0 2px;
    display: block;
}

body.light-theme .label {
    color: #000000;
}

#themeToggle {
    position: fixed;
    top: 10px;
    right: 25px;
    padding: 10px 15px;
    border-radius: 4px;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: #e0e0e0;
    cursor: pointer;
    z-index: 1000;
    font-size: 24px;
}

body.light-theme #themeToggle {
    background: rgba(0, 0, 0, 0.1);
    border-color: rgba(0, 0, 0, 0.2);
    color: #2c3e50;
}

#createStrategicGoal {
    position: fixed;
    top: 10px;
    left: 20px;
    padding: 10px 15px;
    border-radius: 4px;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: #e0e0e0;
    cursor: pointer;
    z-index: 1000;
}

body.light-theme #createStrategicGoal {
    background: rgba(0, 0, 0, 0.1);
    border-color: rgba(0, 0, 0, 0.2);
    color: #2c3e50;
}

#createStrategicGoal:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.strategic-goal-form {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(15, 15, 25, 0.95);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    padding: 20px;
    z-index: 1000;
    width: 500px;
    margin-top: 20px;
}

body.light-theme .strategic-goal-form {
    background: rgba(255, 255, 255, 0.95);
}

.connector {
    position: absolute;
    pointer-events: none;
    z-index: 0;
}

.modal-content {
    background: rgba(40, 40, 60, 0.95) !important;
    backdrop-filter: blur(12px);
    border: 1px solid rgba(255, 255, 255, 0.15);
    border-radius: 12px;
    z-index: 1055 !important;
    position: relative;
}

.modal-header {
    background: linear-gradient(135deg, #2A3F54 0%, #1ABB9C 100%);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    padding: 1rem;
}

.modal-title {
    font-size: 1.25rem;
    color: #e0e0e0;
}

.modal-body {
    color: #e0e0e0;
    background-color: black;
    padding: 1rem;
}

.modal-footer {
    padding: 1rem;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
}

.btn-close-white {
    filter: invert(1);
}

#my-form {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    margin-top: 150px;
    width: 400px;
    margin-left: auto;
    margin-right: auto;
    background: transparent;
}

.field-container {
    display: flex;
    flex-direction: column;
    background: transparent;
}

.field-label {
    margin-bottom: 0.3rem;
    font-weight: bold;
    color: white;
    background: transparent;
}

.input-small {
    padding: 0.5rem;
    font-size: 1rem;
    border: 1px solid #ccc;
    border-radius: 4px;
    background: transparent;
    color: white;
    caret-color: white;
}

.input-small::placeholder {
    color: rgba(255, 255, 255, 0.5);
}

.checkbox-label {
    margin-top: 0.3rem;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    gap: 0.4rem;
    color: white;
    background: transparent;
}

.username-wrapper {
    display: flex;
    align-items: center;
    background: transparent;
}

.username-wrapper i {
    color: white;
    padding-right: 0.25rem;
    background: transparent;
}

.username-input {
    background: transparent !important;
    border: none;
    color: white;
    padding-left: 0;
    font-size: 0.875rem;
    outline: none;
}

.username-input::placeholder {
    color: rgba(255, 255, 255, 0.5);
}

.select2-container--default .select2-dropdown {
    z-index: 10010 !important;
}

.select2-container {
    z-index: 10000 !important;
    width: 100% !important;
}

.select2-container .select2-selection {
    background-color: transparent;
    border: 1px solid #ccc;
    padding: 6px;
    width: 100%;
}

.select2-container--default .select2-selection--single {
    background-color: transparent;
}

#employee-select {
    width: 100%;
}

#data-table {
    table-layout: auto;
    width: 100%;
    border-collapse: collapse;
    position: relative;
    margin-top: 20px;
    border-radius: 8px;
}

#data-table thead {
    position: sticky;
    top: 0;
    background-color: #222;
    z-index: 1000;
}

body.light-theme #data-table thead {
    background-color: #f5f5f5;
}

#data-table th,
#data-table td {
    padding: 8px;
    border: 1px solid #ddd;
    text-align: left;
    font-size: 10.5px;
    vertical-align: top;
}

#data-table th {
    font-weight: bold;
}

#data-table td {
    word-wrap: break-word;
    white-space: nowrap;
}

#data-table td:nth-child(6),
#data-table td:nth-child(9),
#data-table td:nth-child(12),
#data-table td:nth-child(15) {
    min-width: 250px;
    max-width: none;
}

#data-table input,
#data-table select,
#data-table textarea {
    border: none;
    background: transparent;
    font-size: 12px;
    color: #e0e0e0;
    padding: 2px;
    margin: 0;
    width: 100%;
    resize: none;
    overflow: hidden;
}

body.light-theme #data-table input,
body.light-theme #data-table select,
body.light-theme #data-table textarea {
    color: #2c3e50;
}

button {
    background: linear-gradient(145deg, #00b4d8, #0077b6);
    border: none;
    padding: 6px 12px;
    border-radius: 8px;
    color: white;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

button:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 180, 216, 0.3);
}

.save-button:hover {
    background: blue;
}

.delete-button:hover {
    background: red;
}

.modal-overlay,
#modalOverlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.9);
    backdrop-filter: blur(8px);
    z-index: 10000;
    justify-content: center;
    align-items: center;
}

#modalClose {
    position: absolute;
    top: 10px;
    right: 15px;
    font-size: 20px;
    cursor: pointer;
    color: #e0e0e0;
    background: transparent;
    border: none;
}

body.light-theme #modalClose {
    color: #2c3e50;
}

@media (max-width: 768px) {
    #data-table {
        display: block;
        overflow-x: auto;
        white-space: nowrap;
    }
}

#table-container {
    max-height: 500px;
    overflow-y: auto;
    overflow-x: auto;
    position: relative;
}

.button-container {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 10px;
    margin-top: 10px;
}

.button-container button {
    width: 80px;
    height: 30px;
    font-size: 14px;
    border-radius: 5px;
    border: none;
    cursor: pointer;
}

#delete-button {
    background-color: #dc3545;
    color: #fff;
}

.save-button {
    background-color: #007bff;
    color: #fff;
}

.close-button {
    background-color: #6c757d;
    color: #fff;
}

#modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    display: none;
    justify-content: center;
    align-items: center;
}

#table-container {
    overflow-x: auto;
    overflow-y: auto;
    max-height: 60vh;
}

#data-table {
    width: 100%;
    border-collapse: collapse;
}

#data-table th,
#data-table td {
    border: 1px solid #ddd;
    padding: 10px;
    text-align: left;
}

nav {
    position: fixed;
    top: 50px;
    left: 0;
    width: 10%;
    height: calc(100vh - 50px);
    background: linear-gradient(135deg, #2A3F54 0%, #1ABB9C 100%);
    box-shadow: 4px 0 15px rgba(0,0,0,0.2);
    z-index: 1030;
    padding: 1rem;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    box-sizing: border-box;
}

.nav-btn {
    width: 50px;
    height: 50px;
    background-color: #34495e;
    border-radius: 12px;
    margin: 10px 0;
    border: none;
    cursor: pointer;
    transition: background-color 0.3s ease;
}

.nav-btn:hover {
    background-color: #1ABB9C;
}

.sidebar-button {
    width: 100%;
    background: linear-gradient(180deg, #3498DB, #2980B9);
    color: #e0f7ff;
    border: none;
    border-radius: 30px;
    padding: 0.6rem 0.75rem;
    font-size: 0.75rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
}

.sidebar-button i {
    margin-bottom: 0.10rem;
}

#set-date { background: linear-gradient(180deg, #3498DB, #2980B9); }
.btn-refresh { background: linear-gradient(180deg, #2ECC71, #27AE60); color: white; }
.assignees-btn { background: linear-gradient(180deg, #9B59B6, #8E44AD); }
.inherit-btn { background: linear-gradient(180deg, #E74C3C, #C0392B); color: #ffeaea; }
.help-btn { background: linear-gradient(180deg, #1ABC9C, #16A085); color: white; }
.table-btn { background: linear-gradient(180deg, #F39C12, #D35400); color: white; }

@keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(26, 187, 156, 0.6); transform: scale(1); opacity: 0.5; }
    50% { transform: scale(1.15); opacity: 0.8; }
    70% { box-shadow: 0 0 0 15px rgba(26, 187, 156, 0); }
    100% { box-shadow: 0 0 0 0 rgba(26, 187, 156, 0); transform: scale(1); opacity: 0.5; }
}

.dashboard-title {
    text-align: center;
    font-size: 2.8rem;
    margin: 2rem 0;
    background: linear-gradient(45deg, #1ABB9C, #4facfe);
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent;
    font-weight: 700;
}

.dashboard-subtitle {
    text-align: center;
    font-size: 1.2rem;
    margin-bottom: 3rem;
    color: #94a3b8;
    max-width: 800px;
    margin-left: auto;
    margin-right: auto;
}

.dashboard-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 25px;
    margin-top: 30px;
}

.dashboard-card {
    background: rgba(15, 25, 45, 0.7);
    border-radius: 16px;
    padding: 25px;
    border: 1px solid rgba(74, 222, 128, 0.1);
    transition: all 0.3s ease;
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
}

.dashboard-card:hover {
    transform: translateY(-8px);
    border-color: rgba(74, 222, 128, 0.3);
    box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
}

.dashboard-card h3 {
    font-size: 1.5rem;
    margin-bottom: 15px;
    color: #4facfe;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 15px;
    margin-top: 15px;
}

.stat-item {
    background: rgba(30, 45, 70, 0.8);
    border-radius: 10px;
    padding: 15px;
    text-align: center;
}

.stat-value {
    font-size: 2rem;
    font-weight: 700;
    color: #1ABB9C;
    margin: 5px 0;
}

.stat-label {
    font-size: 0.95rem;
    color: #94a3b8;
}

.progress-container {
    margin-top: 20px;
}

.progress-bar {
    height: 10px;
    background: rgba(30, 45, 70, 0.8);
    border-radius: 5px;
    overflow: hidden;
    margin-top: 8px;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #1ABB9C, #4facfe);
    border-radius: 5px;
}

.footer {
    text-align: center;
    padding: 2rem;
    margin-top: 5rem;
    color: #94a3b8;
    font-size: 0.9rem;
    border-top: 1px solid rgba(74, 222, 128, 0.1);
}

#themeToggle {
  position: fixed;
  top: 0;
  right: 0;
}
</style>

<body>
<!-- Date Modal (Unchanged) -->
<div class="modal fade" id="t_dateModal" tabindex="-1" aria-labelledby="t_dateModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius: 15px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.2); border: none;">
            <div class="t_modal-header">
                <h5 class="modal-title" style="font-weight: 600;"><i class="fas fa-calendar" style="margin-right: 10px;"></i>Set Due Dates</h5>
            </div>
            <div class="modal-body" style="padding: 25px;">
                <div style="display: grid; gap: 10px;">
                    <button type="button" class="t_btn-date-option" data-date-type="kp1">
                        <div>
                            <i class="fas fa-flag" style="margin-right: 10px;"></i> KPI due date
                        </div>
                        <div id="t_kp1-display" class="t_date-display">Not set</div>
                    </button>
                    <button type="button" class="t_btn-date-option" data-date-type="deliverable">
                        <div>
                            <i class="fas fa-truck" style="margin-right: 10px;"></i> Deliverable due date
                        </div>
                        <div id="t_deliverable-display" class="t_date-display">Not set</div>
                    </button>
                    <button type="button" class="t_btn-date-option" data-date-type="document">
                        <div>
                            <i class="fas fa-file-alt" style="margin-right: 10px;"></i> Document Evidence due date
                        </div>
                        <div id="t_document-display" class="t_date-display">Not set</div>
                    </button>
                    <button type="button" class="t_btn-date-option" data-date-type="all">
                        <div>
                            <i class="fas fa-globe" style="margin-right: 10px;"></i> Due Date for all
                        </div>
                        <div id="t_all-display" class="t_date-display">Set all</div>
                    </button>
                </div>
                <div id="t_datePickerContainer" class="t_date-picker-container">
                    <h6 id="t_datePickerTitle" style="margin-bottom: 15px;">Select a date</h6>
                    <div style="display: flex; justify-content: center;">
                        <input type="date" id="t_datePicker" style="padding: 8px; border-radius: 5px; border: 1px solid #ddd; width: 100%;">
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-top: 15px;">
                        <button id="t_cancelDate" style="background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; border: none; padding: 8px 15px; border-radius: 5px;"><i class="fas fa-times" style="margin-right: 5px;"></i> Cancel</button>
                        <button id="t_confirmDate" style="background: linear-gradient(135deg, #2ecc71, #27ae60); color: white; border: none; padding: 8px 15px; border-radius: 5px;"><i class="fas fa-check" style="margin-right: 5px;"></i> Set Date</button>
                    </div>
                </div>
            </div>
            <div class="t_modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="closeDateModal()">Close</button>
            </div>
        </div>
    </div>
</div>




    <form id="dueDateForm">
        <div class="mb-3" >
            <label for="kpiDueDate" class="form-label"  style=" display: none;">KPI Due Date</label>
            <input type="text" class="form-control"  style=" display: none;" id="kpiDueDate" readonly>
        </div>
        <div class="mb-3">
            <label for="deliverableDueDate" class="form-label"  style=" display: none;" >Deliverable Due Date</label>
            <input type="text" class="form-control"  style=" display: none;" id="deliverableDueDate" readonly>
        </div>
        <div class="mb-3">
            <label for="documentDueDate" class="form-label"  style=" display: none;">Document Evidence Due Date</label>
            <input type="text" class="form-control"  style=" display: none;" id="documentDueDate" readonly>
        </div>
        <div class="mb-3">
            <label for="allDueDate" class="form-label"  style=" display: none;">All Due Date</label>
            <input type="text" class="form-control"  style=" display: none;" id="allDueDate" readonly>
        </div>
    </form>


<!-- Form with Password Field Hidden -->
<form id="my-form" style="display: none;">
    <div class="field-container">
        <label class="field-label" for="username-input">Employee Name:</label>
        <input class="input-small" type="text" id="username-input" name="username" placeholder="Name">
    </div>

    <!-- Password field container hidden -->
    <div class="field-container" style="display: none;">
        <label class="field-label" for="employee-password">Password:</label>
        <input class="input-small" type="password" id="employee-password" name="employee_password" placeholder="Password" style="display: none;">
        <label class="checkbox-label" style="display: none;">
            <input type="checkbox" id="show-password" style="display: none;"> Show
        </label>
    </div>   

    <div class="field-container">
        <label class="field-label" for="company_code">Company Code:</label>
        <input class="input-small" type="text" id="company_code" name="company_code" placeholder="Company Code">
    </div>

    <div class="field-container">
        <label class="field-label" for="branch_code">Branch Code:</label>
        <input class="input-small" type="text" id="branch_code" name="branch_code" placeholder="Branch Code">
    </div>

    <div class="field-container">
        <label class="field-label" for="region_branch">Region Branch:</label>
        <input class="input-small" type="text" id="region_branch" name="region_branch" placeholder="Region Branch">
    </div>
    <div class="field-container" id="department">
        <label class="field-label" for="department_name">Department:</label>
        <input class="input-small" type="text" id="department_name" name="department_name" placeholder="Department Name">
    </div>
</form>

<body style="margin:0;padding:0;height:100vh;display:flex;justify-content:center;align-items:center;background:linear-gradient(135deg, #0c1d2c 0%, #1a2a3a 100%);overflow:hidden;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;">
    <!-- Floating background elements -->
    <div style="position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;">
        <div style="position:absolute;top:20%;left:10%;width:200px;height:200px;border-radius:50%;background:radial-gradient(circle, rgba(26,187,156,0.15) 0%, transparent 70%);"></div>
        <div style="position:absolute;top:60%;left:80%;width:150px;height:150px;border-radius:50%;background:radial-gradient(circle, rgba(74,172,254,0.15) 0%, transparent 70%);"></div>
        <div style="position:absolute;top:40%;left:70%;width:180px;height:180px;border-radius:50%;background:radial-gradient(circle, rgba(26,187,156,0.1) 0%, transparent 70%);"></div>
    </div>
<body>
    <!-- Fixed and Clean Navigation Bar -->
    <nav id="mainNav" style="position: fixed; top: 0; left: 0; width: 12%; z-index: 999;
                display: flex; flex-direction: column; align-items: center; gap: 1rem;
                padding: 1rem 2rem; background: rgba(15, 25, 40, 0.95); height: 100vh;
                border-right: 1px solid rgba(26, 187, 156, 0.2); transition: all 0.5s ease;">
        <!-- User Input Section -->
        <div style="display: flex; align-items: center; gap: 0.5rem;
                    border-radius: 10px; padding: 0.5rem 1.25rem; margin-top: 1rem;">
            <input type="text" id="navbar-username-input" class="username-input" value="Admin" readonly
                   style="background: transparent; border: none; color: #fff; font-weight: 500;
                          font-size: 0.9rem; max-width: 120px; cursor: default;">
        </div>

        <!-- Home Button -->
        <a href="#" title="Home"
           style="color: #ffffff; text-decoration: none; display: flex; align-items: center;
                  background: none; border-radius: 50%; width: 36px; height: 36px; justify-content: center; margin-top: 1rem;">
            <i class="fas fa-home" style="color: #b0f0ff;"></i>
        </a>

        <!-- Other Buttons -->
        <button id="set-date" onclick="openDateModal()" class="sidebar-button"
                style="background: rgba(30, 45, 70, 0.7); border: none; border-radius: 8px; 
                       color: #b0f0ff; padding: 10px; width: 100%; text-align: left; cursor: pointer;
                       display: flex; align-items: center; gap: 10px; transition: all 0.3s ease;">
            <i class="fas fa-calendar-alt"></i>Set Date
        </button>

        <button type="button" class="btn-refresh sidebar-button" onclick="refreshDueDates()"
                style="background: rgba(30, 45, 70, 0.7); border: none; border-radius: 8px; 
                       color: #b0f0ff; padding: 10px; width: 100%; text-align: left; cursor: pointer;
                       display: flex; align-items: center; gap: 10px; transition: all 0.3s ease;">
            <i class="fas fa-sync-alt"></i>Refresh
        </button>

        <button class="assignees-btn sidebar-button" data-bs-toggle="modal" data-bs-target="#assigneesModal"
                style="background: rgba(30, 45, 70, 0.7); border: none; border-radius: 8px; 
                       color: #b0f0ff; padding: 10px; width: 100%; text-align: left; cursor: pointer;
                       display: flex; align-items: center; gap: 10px; transition: all 0.3s ease;">
            <i class="fas fa-users"></i>Assignees
        </button>

        <button id="openInheritModal" class="inherit-btn sidebar-button"
            style="background: rgba(30, 45, 70, 0.7); border: none; border-radius: 8px; 
                color: #b0f0ff; padding: 10px; width: 100%; text-align: left; cursor: pointer;
                display: flex; align-items: center; gap: 10px; transition: all 0.3s ease;">
            <i class="fas fa-user-shield"></i>Enherit
        </button>

        <button class="sidebar-button table-btn" onclick="toggleTable()"
                style="background: rgba(30, 45, 70, 0.7); border: none; border-radius: 8px; 
                       color: #b0f0ff; padding: 10px; width: 100%; text-align: left; cursor: pointer;
                       display: flex; align-items: center; gap: 10px; transition: all 0.3s ease;">
            <i class="fas fa-table"></i>Table
        </button>

        <!-- Start Cascading Button -->
        <button id="createStrategicGoal"
            style="width: 85px; height: 90px; border: none;
                   background: radial-gradient(circle at center, rgba(30,40,50,0.95) 0%, rgba(15,25,35,0.95) 100%);
                   cursor: pointer; border-radius: 24px;
                   box-shadow: 0 12px 30px rgba(0,0,0,0.6), 
                               inset 0 0 0 1px rgba(255,255,255,0.1),
                               inset 0 0 30px rgba(26,187,156,0.3);
                   transition: all 0.4s cubic-bezier(0.4,0,0.2,1);
                   z-index: 1000;
                   position: relative; 
                   align-self: center;
                   left: -0.1cm;
                   margin-top: 2rem;"
            onmouseenter="this.style.transform='scale(1.05)';this.style.boxShadow='0 15px 40px rgba(0,0,0,0.8), inset 0 0 0 1px rgba(255,255,255,0.15), inset 0 0 40px rgba(26,187,156,0.5)';document.getElementById('pulse-ring').style.transform='scale(1.15)';document.getElementById('pulse-ring').style.opacity='0.8';" 
            onmouseleave="this.style.transform='scale(1)';this.style.boxShadow='0 12px 30px rgba(0,0,0,0.6), inset 0 0 0 1px rgba(255,255,255,0.1), inset 0 0 30px rgba(26,187,156,0.3)';document.getElementById('pulse-ring').style.transform='scale(1)';document.getElementById('pulse-ring').style.opacity='0.5';">

            <div style="position:relative;width:100%;height:100%;">
                <!-- Pulse ring -->
                <div id="pulse-ring" style="position:absolute;top:15%;left:15%;width:70%;height:70%;
                        border:2px solid rgba(26,187,156,0.5);border-radius:16px;
                        background:rgba(26,187,156,0.1);
                        box-shadow:0 0 20px rgba(26,187,156,0.3);
                        display:flex;justify-content:center;align-items:center;
                        transition:all 0.4s ease;opacity:0.5;
                        animation:pulse 3s infinite ease-in-out;">
                </div>

                <!-- Gradient text -->
                <div style="position:absolute;top:70%;left:50%;transform:translateX(-50%);
                        width:100%;text-align:center;padding:0 20px;">
                    <span style="font-size:1.3rem; font-weight:600; letter-spacing:1px;
                                background:linear-gradient(45deg, #1ABB9C, #4facfe);
                                -webkit-background-clip:text;
                                background-clip:text;
                                color:transparent;
                                text-shadow:0 0 10px rgba(26,187,156,0.4);
                                margin-left: -25px;
                                position: relative;
                                top: -0.5cm;">
                        Start
                    </span>
                </div>

                <!-- Particles -->
                <div style="position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;">
                    <div style="position:absolute;width:8px;height:8px;border-radius:50%;background:rgba(26,187,156,0.6);top:20%;left:25%;"></div>
                    <div style="position:absolute;width:6px;height:6px;border-radius:50%;background:rgba(74,172,254,0.5);top:35%;left:75%;"></div>
                    <div style="position:absolute;width:5px;height:5px;border-radius:50%;background:rgba(26,187,156,0.4);top:65%;left:15%;"></div>
                </div>
            </div>
        </button>
        <br>
    </nav>


<div id="container" 
     style="position: absolute; top: 0; left: 0;
            display: flex; justify-content: center; align-items: center;">
</div>

<!-- Theme Toggle -->
<button id="themeToggle" style="background: rgba(255,255,255,0.2); border: none; border-radius: 50%; width: 36px; height: 36px; color: #FFD43B; font-size: 1.1rem; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center; ">ðŸŒ‘</button>
    <!-- Help Modal -->
<section id="strategic-goal-cascading" style="padding: 20px; margin-top: 27rem; margin-left: 100px;">
    <div style="max-width: 900px; margin: 0 auto;">
        <h2 style="color: #fff; margin-bottom: 1.5rem; display: flex; align-items: center;">
            <i class="fas fa-project-diagram" style="margin-right: 0.5rem;"></i>
            Strategic Goal Cascading Framework
        </h2>
        <p style="color: #a0a0a0; margin-bottom: 2rem; line-height: 1.6;">
            Our 4-stage framework transforms high-level strategy into actionable tasks with measurable outcomes. 
            Each stage builds upon the previous, creating clear accountability and audit trails.
        </p>

        <!-- Stage 1 -->
        <div style="display: flex; margin-bottom: 30px; padding: 25px; background: rgba(255,255,255,0.05); border-radius: 12px; border-left: 4px solid #2ECC71;">
            <div style="width: 60px; height: 60px; border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-right: 20px; flex-shrink: 0; background: linear-gradient(135deg, #2ECC71, #1ABB9C);">
                <i class="fas fa-bullseye" style="color: white; font-size: 1.8rem;"></i>
            </div>
            <div>
                <h5 style="font-family: 'Merriweather', serif; font-size: 1.2rem; color: #fff; display: flex; align-items: center;">
                    Stage 1: Strategic Goals 
                    <span style="font-size: 0.8rem; padding: 4px 10px; border-radius: 4px; margin-left: 12px; background: rgba(46, 204, 113, 0.2);">Strategic Foundation</span>
                </h5>
                <p style="font-size: 0.95rem; line-height: 1.7; color: #d0d0d0; margin-top: 10px;">
                    <strong>Leadership defines organizational priorities</strong> aligned with long-term vision. 
                    Administrators establish department-specific objectives with:
                </p>
                <ul style="color: #c0c0c0; padding-left: 20px; margin-top: 8px; font-size: 0.9rem;">
                    <li>Clear success metrics</li>
                    <li>Assigned ownership</li>
                    <li>Weighted importance (0-100%)</li>
                    <li>Specific deadlines</li>
                </ul>
                <div style="background: rgba(46, 204, 113, 0.1); padding: 12px; border-radius: 8px; margin-top: 15px;">
                    <i class="fas fa-lightbulb" style="color: #2ECC71; margin-right: 8px;"></i>
                    <span style="font-weight: 500; color: #2ECC71;">Pro Tip:</span> 
                    Limit to 3-5 goals per department. Research by Bain & Company shows organizations with fewer than 5 strategic goals achieve 30% higher execution success rates.
                </div>
            </div>
        </div>

        <!-- Connector -->
        <div style="display: flex; justify-content: center; margin-bottom: 20px;">
            <div style="width: 2px; height: 40px; background: linear-gradient(180deg, #2ECC71, #3498DB);"></div>
        </div>

        <!-- Stage 2 -->
        <div style="display: flex; margin-bottom: 30px; padding: 25px; background: rgba(255,255,255,0.05); border-radius: 12px; border-left: 4px solid #3498DB;">
            <div style="width: 60px; height: 60px; border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-right: 20px; background: linear-gradient(135deg, #3498DB, #2980B9);">
                <i class="fas fa-chart-line" style="color: white; font-size: 1.8rem;"></i>
            </div>
            <div>
                <h5 style="font-family: 'Merriweather', serif; font-size: 1.2rem; color: #fff; display: flex; align-items: center;">
                    Stage 2: Key Performance Indicators 
                    <span style="font-size: 0.8rem; padding: 4px 10px; border-radius: 4px; margin-left: 12px; background: rgba(52, 152, 219, 0.2);">Performance Measurement</span>
                </h5>
                <p style="font-size: 0.95rem; line-height: 1.7; color: #d0d0d0; margin-top: 10px;">
                    <strong>Transform objectives into quantifiable metrics</strong> that track progress toward strategic goals. 
                    Each KPI includes:
                </p>
                <ul style="color: #c0c0c0; padding-left: 20px; margin-top: 8px; font-size: 0.9rem;">
                    <li>Baseline and target values</li>
                    <li>Measurement frequency</li>
                    <li>Assigned team members</li>
                    <li>Progress visualization</li>
                </ul>
                <!-- Updated Stage 2: Key Performance Indicators - Team Alignment -->
                <div style="background: rgba(52, 152, 219, 0.1); padding: 12px; border-radius: 8px; margin-top: 15px;">
                    <i class="fas fa-users" style="color: #3498DB; margin-right: 8px;"></i>
                    <span style="font-weight: 500; color: #3498DB;">Team Alignment:</span> 
                    Assign each KPI to at least 2 stakeholders. Gallup studies reveal dual-ownership increases accountability and reduces single-point failure risks by 45%.
                </div>
            </div>
        </div>

        <!-- Connector -->
        <div style="display: flex; justify-content: center; margin-bottom: 20px;">
            <div style="width: 2px; height: 40px; background: linear-gradient(180deg, #3498DB, #E67E22);"></div>
        </div>

        <!-- Stage 3 -->
        <div style="display: flex; margin-bottom: 30px; padding: 25px; background: rgba(255,255,255,0.05); border-radius: 12px; border-left: 4px solid #E67E22;">
            <div style="width: 60px; height: 60px; border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-right: 20px; background: linear-gradient(135deg, #E67E22, #D35400);">
                <i class="fas fa-tasks" style="color: white; font-size: 1.8rem;"></i>
            </div>
            <div>
                <h5 style="font-family: 'Merriweather', serif; font-size: 1.2rem; color: #fff; display: flex; align-items: center;">
                    Stage 3: Deliverables 
                    <span style="font-size: 0.8rem; padding: 4px 10px; border-radius: 4px; margin-left: 12px; background: rgba(230, 126, 34, 0.2);">Execution Phase</span>
                </h5>
                <p style="font-size: 0.95rem; line-height: 1.7; color: #d0d0d0; margin-top: 10px;">
                    <strong>Define tangible outputs</strong> that contribute to KPI achievement. Each deliverable specifies:
                </p>
                <ul style="color: #c0c0c0; padding-left: 20px; margin-top: 8px; font-size: 0.9rem;">
                    <li>Clear success criteria</li>
                    <li>Milestone deadlines</li>
                    <li>Resource requirements</li>
                    <li>Quality standards</li>
                </ul>
                <!-- Updated Stage 3: Deliverables - Best Practice -->
                <div style="background: rgba(230, 126, 34, 0.1); padding: 12px; border-radius: 8px; margin-top: 15px;">
                    <i class="fas fa-clipboard-check" style="color: #E67E22; margin-right: 8px;"></i>
                    <span style="font-weight: 500; color: #E67E22;">Best Practice:</span> 
                    Apply the "Definition of Ready" framework. MIT Sloan research shows clearly defined acceptance criteria reduces rework by 65% and accelerates delivery by 40%.
                </div>
            </div>
        </div>

        <!-- Connector -->
        <div style="display: flex; justify-content: center; margin-bottom: 20px;">
            <div style="width: 2px; height: 40px; background: linear-gradient(180deg, #E67E22, #9B59B6);"></div>
        </div>

        <!-- Stage 4 -->
        <div style="display: flex; margin-bottom: 30px; padding: 25px; background: rgba(255,255,255,0.05); border-radius: 12px; border-left: 4px solid #9B59B6;">
            <div style="width: 60px; height: 60px; border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-right: 20px; background: linear-gradient(135deg, #9B59B6, #8E44AD);">
                <i class="fas fa-file-alt" style="color: white; font-size: 1.8rem;"></i>
            </div>
            <div>
                <h5 style="font-family: 'Merriweather', serif; font-size: 1.2rem; color: #fff; display: flex; align-items: center;">
                    Stage 4: Document Evidence 
                    <span style="font-size: 0.8rem; padding: 4px 10px; border-radius: 4px; margin-left: 12px; background: rgba(155, 89, 182, 0.2);">Verification & Compliance</span>
                </h5>
                <p style="font-size: 0.95rem; line-height: 1.7; color: #d0d0d0; margin-top: 10px;">
                    <strong>Attach proof of completion</strong> to validate deliverable achievement. Supported evidence types:
                </p>
                <ul style="color: #c0c0c0; padding-left: 20px; margin-top: 8px; font-size: 0.9rem;">
                    <li>Reports and analytics dashboards</li>
                    <li>Certifications and compliance documents</li>
                    <li>System-generated outputs</li>
                    <li>Client testimonials</li>
                </ul>
                <!-- Updated Stage 4: Document Evidence - Audit Ready -->
                <div style="background: rgba(155, 89, 182, 0.1); padding: 12px; border-radius: 8px; margin-top: 15px;">
                    <i class="fas fa-shield-alt" style="color: #9B59B6; margin-right: 8px;"></i>
                    <span style="font-weight: 500; color: #9B59B6;">Audit Ready:</span> 
                    Implement the 3-2-1 rule: 3 copies across 2 media types with 1 offsite. ISO 27001 compliance requires evidence retention for 7+ years in regulated industries.
                </div>
            </div>
        </div>
    </div>
</section>



<!-- Assignees Modal -->
<div class="modal fade" id="assigneesModal" tabindex="-1" aria-labelledby="assigneesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" style="margin-top: 125px">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="assigneesModalLabel">
                    <i class="fas fa-users" style="margin-right: 0.5rem;"></i>Assign KPIs to Team Members
                </h5>
                <button type="button" class="btn-close btn-close-white" style="display:none;" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <select class="form-select" id="employee-select" multiple="multiple">
                </select>
                <input type="hidden" id="selected-employee" name="selected_employee">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="saveAssignees">
                    <i class="fas fa-check" style="margin-right: 0.5rem;"></i>Submit
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Inherit Modal Overlay -->
<div id="inheritModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
     background-color: rgba(0, 0, 0, 0.7); z-index: 9999; overflow-y: auto;">

    <div class="modal-dialog modal-lg" style="margin: 100px auto; max-width: 800px;">
        <div class="modal-content" style="background-color: #1e2d46; color: white; border-radius: 12px;">
            <div class="modal-header">
                <h5 class="modal-title" id="inheritModalLabel">
                    <i class="fas fa-share" style="margin-right: 0.5rem;"></i>Inherit from Team Member(s)
                </h5>
                <button onclick="closeInheritModal()" class="btn-close btn-close-white" aria-label="Close"></button>
            </div>

            <div class="modal-body">
                <label for="employee-inherit" class="form-label" style="color: #fff;">Inherit from:</label>
                <select class="form-select" id="employee-inherit" required style="background-color: #000; color: #fff;">
                    <!-- options dynamically inserted -->
                </select>

                <label for="select-inherit-1" class="form-label" style="margin-top: 1rem;">To:</label>
                <select class="form-select" id="select-inherit-1" multiple style="background-color: #000; color: #fff;">
                </select>

                <div style="display: none; margin-top: 1rem;">
                    <input type="text" id="employee_code" name="employee_code"
                           style="width: 120px; font-size: 12px; padding: 4px;"
                           placeholder="Enter Code" />
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="saveInherit">
                    <i class="fas fa-check" style="margin-right: 0.5rem;"></i>Inherit
                </button>
                <button onclick="closeInheritModal()" class="btn btn-secondary">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>

    <!-- Table Modal -->
    <div class="modal-overlay" id="modal-overlay" style="display: none;">
        <div class="modal-content" style="background-color: #fff;padding: 20px;border-radius: 10px;box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);width: 99%;max-height: 80vh;
    overflow-y: auto;
    margin-top: -200px;">
            <div id="table-container">
                <table id="data-table">
                    <thead>
                        <tr>
                            <th>Employee Name</th>
                            <th>Strategic Goal #</th>
                            <th>Strategic Goal</th>
                            <th>Strategic Goal Weight</th>
                            <th>Strategic Goal Due Date</th>
                            <th>KPI #</th>
                            <th>KPI</th>
                            <th>KPI Weight</th>
                            <th>KPI Due Date</th>
                            <th>Deliverable #</th>
                            <th>Deliverable</th>
                            <th>Deliverable Weight</th>
                            <th>Deliverable Due Date</th>
                            <th>Document Evidence #</th>
                            <th>Document Evidence</th>
                            <th>Document Evidence Weight</th>
                            <th>Document Evidence Due Date</th>
                            <th>Select</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="button-container">
                <button id="delete-button" class="btn btn-danger">Delete</button>
                <button class="close-button" onclick="toggleTable()">Ã—</button>
                <button class="save-button">Save</button>
            </div>
        </div>
    </div>
</body>


<script>
// Inherit Modal Logic
const modal = document.getElementById('inheritModal');
const openBtn = document.getElementById('openInheritModal');

openBtn.addEventListener('click', () => {
    modal.style.display = 'block';
});

function closeInheritModal() {
    modal.style.display = 'none';
}

window.addEventListener('click', (e) => {
    if (e.target === modal) {
        closeInheritModal();
    }
});



// Main Event Listeners
document.addEventListener('DOMContentLoaded', function() {
    const startButton = document.getElementById('createStrategicGoal');
    const cascadingSection = document.getElementById('strategic-goal-cascading');
    const navBar = document.getElementById('mainNav');

    startButton.addEventListener('click', function() {
        this.style.transform = 'translateY(40px) scale(0)';
        cascadingSection.style.opacity = '0';
        cascadingSection.style.transform = 'translateY(50px)';
        setTimeout(() => {
            cascadingSection.remove();
        }, 500);

        navBar.style.width = '100%';
        navBar.style.height = '80px';
        navBar.style.flexDirection = 'row';
        navBar.style.justifyContent = 'space-around';
        navBar.style.alignItems = 'center';
        navBar.style.padding = '0 20px';
        navBar.style.borderRight = 'none';
        navBar.style.borderBottom = '1px solid rgba(26, 187, 156, 0.2)';

        setTimeout(() => {
            this.style.display = 'none';
        }, 300);

        setTimeout(() => {
            createStrategicGoalForm();
        }, 350);
    });

    // Sidebar button hover effects
    const sidebarButtons = document.querySelectorAll('.sidebar-button');
    sidebarButtons.forEach(button => {
        button.addEventListener('mouseenter', function() {
            this.style.background = 'rgba(26, 187, 156, 0.3)';
            this.style.transform = 'translateY(-3px)';
        });
        button.addEventListener('mouseleave', function() {
            this.style.background = 'rgba(30, 45, 70, 0.7)';
            this.style.transform = 'translateY(0)';
        });
    });

    // Date Modal Logic
    let t_currentDateType = null;

    function t_showDatePicker(dateType) {
        t_currentDateType = dateType;
        const container = document.getElementById('t_datePickerContainer');
        const title = document.getElementById('t_datePickerTitle');

        switch (dateType) {
            case 'kp1':
                title.innerHTML = '<i class="fas fa-flag" style="margin-right: 10px;"></i>Select KPI due date';
                break;
            case 'deliverable':
                title.innerHTML = '<i class="fas fa-truck" style="margin-right: 10px;"></i>Select deliverable due date';
                break;
            case 'document':
                title.innerHTML = '<i class="fas fa-file-alt" style="margin-right: 10px;"></i>Select Document Evidence due date';
                break;
            case 'all':
                title.innerHTML = '<i class="fas fa-globe" style="margin-right: 10px;"></i>Select due date for all items';
                break;
        }

        container.style.display = 'block';
    }

    document.querySelectorAll('.t_btn-date-option').forEach(button => {
        button.addEventListener('click', function() {
            const dateType = this.getAttribute('data-date-type');
            t_showDatePicker(dateType);
        });
    });

    document.getElementById('t_confirmDate').addEventListener('click', function() {
        const datePicker = document.getElementById('t_datePicker');
        const selectedDate = datePicker.value;

        if (!selectedDate) {
            alert('Please select a date.');
            return;
        }

        saveDueDateToLocalStorage(t_currentDateType, selectedDate);
        document.getElementById('t_datePickerContainer').style.display = 'none';
        datePicker.value = '';
    });
});

// Pulse Ring Toggle
document.getElementById('pulse-ring').addEventListener('click', function() {
    const section = document.getElementById('strategic-goal-cascading');
    section.style.display = (section.style.display === 'none') ? 'block' : 'none';
});

// Due Date Functions
function formatDateForDisplay(dateStr) {
    if (!dateStr || typeof dateStr !== 'string') return 'Not set';
    return dateStr.replace(/-/g, '/');
}

function updateFormFields() {
    const dueDateKp1 = localStorage.getItem('dueDate_kp1');
    const dueDateDeliverable = localStorage.getItem('dueDate_deliverable');
    const dueDateDoc = localStorage.getItem('dueDate_document');
    const dueDateAll = localStorage.getItem('dueDate_all');

    document.getElementById('kpiDueDate').value = formatDateForDisplay(dueDateKp1);
    document.getElementById('deliverableDueDate').value = formatDateForDisplay(dueDateDeliverable);
    document.getElementById('documentDueDate').value = formatDateForDisplay(dueDateDoc);
    document.getElementById('allDueDate').value = formatDateForDisplay(dueDateAll);
}

function refreshDueDates() {
    updateFormFields();
}

function resetDates() {
    localStorage.removeItem('dueDate_kp1');
    localStorage.removeItem('dueDate_deliverable');
    localStorage.removeItem('dueDate_document');
    localStorage.removeItem('dueDate_all');

    updateFormFields();

    if (typeof nodes !== 'undefined' && Array.isArray(nodes)) {
        nodes.forEach(node => {
            node.dueDate = '';
            if (typeof refreshNodeDisplay === 'function') {
                refreshNodeDisplay(node.id);
            }
        });
    }

    if (typeof repositionTree === 'function') {
        repositionTree();
    }
}

function saveDueDateToLocalStorage(dateType, newDate) {
    const formattedDate = formatDateForDisplay(newDate);
    let displayElId;
    let cellIndex = null;

    switch (dateType) {
        case 'kp1':
            localStorage.setItem('dueDate_kp1', newDate);
            displayElId = 't_kp1-display';
            cellIndex = 8;
            break;
        case 'deliverable':
            localStorage.setItem('dueDate_deliverable', newDate);
            displayElId = 't_deliverable-display';
            cellIndex = 12;
            break;
        case 'document':
            localStorage.setItem('dueDate_document', newDate);
            displayElId = 't_document-display';
            break;
        case 'all':
            localStorage.setItem('dueDate_all', newDate);
            localStorage.setItem('dueDate_kp1', newDate);
            localStorage.setItem('dueDate_deliverable', newDate);
            localStorage.setItem('dueDate_document', newDate);
            document.getElementById('t_kp1-display').textContent = formattedDate;
            document.getElementById('t_deliverable-display').textContent = formattedDate;
            document.getElementById('t_document-display').textContent = formattedDate;
            document.getElementById('t_all-display').textContent = formattedDate;
            document.querySelectorAll('#data-table tbody tr').forEach(row => {
                row.cells[8].textContent = formattedDate;
                row.cells[12].textContent = formattedDate;
            });
            displayElId = 't_all-display';
            break;
        default:
            return;
    }

    if (dateType !== 'all') {
        const displayEl = document.getElementById(displayElId);
        if (displayEl) {
            displayEl.textContent = formattedDate;
            displayEl.style.backgroundColor = '#2ecc71';
        }
        if (cellIndex !== null) {
            document.querySelectorAll('#data-table tbody tr').forEach(row => {
                row.cells[cellIndex].textContent = formattedDate;
            });
        }
    }

    applyStoredDueDates();
}

function applyStoredDueDates() {
    const dueDateAll = localStorage.getItem('dueDate_all');
    const dueDateKp1 = localStorage.getItem('dueDate_kp1');
    const dueDateDeliverable = localStorage.getItem('dueDate_deliverable');
    const dueDateDoc = localStorage.getItem('dueDate_document');

    document.getElementById('t_kp1-display').textContent = formatDateForDisplay(dueDateKp1);
    document.getElementById('t_deliverable-display').textContent = formatDateForDisplay(dueDateDeliverable);
    document.getElementById('t_document-display').textContent = formatDateForDisplay(dueDateDoc);
    document.getElementById('t_all-display').textContent = formatDateForDisplay(dueDateAll);

    if (dueDateAll || dueDateKp1) {
        document.querySelectorAll('#data-table tbody tr').forEach(row => {
            row.cells[8].textContent = formatDateForDisplay(dueDateAll || dueDateKp1);
        });
    }
    if (dueDateAll || dueDateDeliverable) {
        document.querySelectorAll('#data-table tbody tr').forEach(row => {
            row.cells[12].textContent = formatDateForDisplay(dueDateAll || dueDateDeliverable);
        });
    }

    if (typeof nodes !== 'undefined' && Array.isArray(nodes)) {
        nodes.forEach(node => {
            if (dueDateAll) {
                node.dueDate = dueDateAll;
            } else {
                switch (node.type) {
                    case NODE_TYPES.KPI:
                        if (dueDateKp1) node.dueDate = dueDateKp1;
                        break;
                    case NODE_TYPES.DELIVERABLE:
                        if (dueDateDeliverable) node.dueDate = dueDateDeliverable;
                        break;
                    case NODE_TYPES.EVIDENCE:
                        if (dueDateDoc) node.dueDate = dueDateDoc;
                        break;
                    case NODE_TYPES.STRATEGIC_GOAL:
                        break;
                }
            }
            if (typeof refreshNodeDisplay === 'function') {
                refreshNodeDisplay(node.id);
            }
        });
    }

    if (typeof repositionTree === 'function') {
        repositionTree();
    }

    updateFormFields();
}

// Modal and Theme Toggle
function closeDateModal() {
    const dateModal = bootstrap.Modal.getInstance(document.getElementById('t_dateModal'));
    if (dateModal) {
        dateModal.hide();
    }
}

window.toggleTable = function() {
    const modal = document.getElementById('modal-overlay');
    modal.style.display = modal.style.display === 'none' || modal.style.display === '' ? 'flex' : 'none';
};

document.getElementById('modal-overlay').addEventListener('click', (e) => {
    if (e.target === document.getElementById('modal-overlay')) {
        toggleTable();
    }
});

const themeToggle = document.getElementById('themeToggle');
let isDarkMode = true;


function openDateModal() {
    const dateModal = new bootstrap.Modal(document.getElementById('t_dateModal'));
    dateModal.show();
}


// === Table Population ===
// Purpose: Populates the data table with user input or API data.
// Explanation: Modified to remove Document Evidence weight and due date fields.
// - Removed 'Document Evidence Weight' and 'Document Evidence Due Date' from fieldMappings.
// - Updated fieldMappingsAPI to exclude these fields.
// Impact: Table no longer includes these columns, aligning with node changes.

window.populateTable = function(apiData = null) {
    const table = document.getElementById("data-table").getElementsByTagName("tbody")[0];
    const fieldMappings = [
        { column: "Manager's name", value: localStorage.getItem('username') || '' },
        { column: "Employee Name", selector: "#selected-employee" },
        { column: "Department", selector: ".department-input" },
        { column: "Region", selector: ".region-input" },
        { column: "Position", selector: ".position-input" },
        { column: "Strategic Goal", selector: "#strategic-goals-dropdown" },
        { column: "Strategic Goal Weight", selector: ".weight-select-sgs", isWeight: true },
        { column: "Strategic Goal Due Date", selector: ".calendar-input-sgs" },
        { column: "KPI", selector: "#kpi-dropdown" },
        { column: "KPI Weight", selector: ".weight-select-kpi", isWeight: true },
        { column: "KPI Due Date", selector: ".calendar-input-kpi" },
        { column: "Deliverable", selector: "#deliverable-dropdown" },
        { column: "Deliverable Weight", selector: ".weight-select-del", isWeight: true },
        { column: "Deliverable Due Date", selector: ".calendar-input-del" },
        { column: "Document Evidence", selector: "#doc_evidence-dropdown" }
    ];
    let missingFields = [];
    let zeroWeightFields = [];
    fieldMappings.forEach(field => {
        if (!field.selector) return;
        const inputElement = document.querySelector(field.selector);
        if (!inputElement || inputElement.value.trim() === "") {
            missingFields.push(field.column);
        } else if (field.isWeight && parseFloat(inputElement.value) === 0) {
            zeroWeightFields.push(field.column);
        }
    });

    function showNotification(message, type = 'msg-error') {
        const modalOverlay = document.createElement('div');
        modalOverlay.className = `msg-overlay ${type}`;
        const notification = document.createElement('div');
        notification.className = `msg-box ${type}`;
        notification.innerHTML = `
            <div class="msg-content">
                <span class="msg-close">Ã—</span>
                ${message}
            </div>
        `;
        modalOverlay.appendChild(notification);
        document.body.appendChild(modalOverlay);
        setTimeout(() => modalOverlay.classList.add('msg-visible'), 10);
        notification.querySelector('.msg-close').addEventListener('click', () => {
            modalOverlay.classList.remove('msg-visible');
            setTimeout(() => modalOverlay.remove(), 500);
        });
        setTimeout(() => {
            modalOverlay.classList.remove('msg-visible');
            setTimeout(() => modalOverlay.remove(), 500);
        }, 5000);
    }

    if (missingFields.length > 0) {
        const message = `<strong>Missing Fields:</strong><ul>${missingFields.map(f => `<li>${f}</li>`).join('')}</ul>`;
        showNotification(message);
        return;
    }
    if (zeroWeightFields.length > 0) {
        const message = `<strong>Invalid Zero Weights:</strong><ul>${zeroWeightFields.map(f => `<li>${f}</li>`).join('')}</ul>`;
        showNotification(message);
        return;
    }

    if (apiData) {
        apiData.forEach(kpiData => {
            const newRow = table.insertRow();
            const fieldMappingsAPI = [
                kpiData.strategic_goal,
                kpiData.strategic_goal_weight,
                kpiData.strategic_goal_due_date,
                kpiData.kpi,
                kpiData.kpi_weight,
                kpiData.kpi_due_date,
                kpiData.deliverable,
                kpiData.deliverable_weight,
                kpiData.deliverable_due_date,
                kpiData.doc_evidence
            ];
            fieldMappingsAPI.forEach(value => {
                const cell = newRow.insertCell();
                cell.textContent = value || "";
            });
            const selectCell = newRow.insertCell();
            const checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            selectCell.appendChild(checkbox);
        });
    } else {
        const newRow = table.insertRow();
        fieldMappings.forEach(field => {
            const cell = newRow.insertCell();
            const inputElement = field.selector ? document.querySelector(field.selector) : null;
            cell.innerHTML = inputElement ? inputElement.value : field.value || "";
        });
        const selectCell = newRow.insertCell();
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        selectCell.appendChild(checkbox);
        showFeedback("Data successfully added to the table!", true);
    }
};

// === Table Deletion ===
// Purpose: Deletes selected table rows.
// Explanation: Unchanged, as it doesn't relate to Document Evidence or password footers.

document.getElementById("delete-button").addEventListener("click", function() {
    const table = document.getElementById("data-table").getElementsByTagName('tbody')[0];
    const rows = Array.from(table.getElementsByTagName("tr"));
    const selectedRows = rows.filter(row => row.querySelector("input[type='checkbox']").checked);
    if (selectedRows.length === 0) {
        showFeedback("No rows selected for deletion.", false);
        return;
    }
    if (!confirm(`You are about to delete ${selectedRows.length} row(s). Are you sure?`)) {
        return;
    }
    selectedRows.forEach(row => table.removeChild(row));
    showFeedback("Selected rows deleted successfully!", true);
});

// === Save Button Placeholder ===
// Purpose: Placeholder for save functionality.
// Explanation: Unchanged, as it doesn't relate to requirements.

document.querySelector('.save-button').addEventListener('click', () => {
    showFeedback('Save functionality not implemented yet.', false);
});

// === Select2 Initialization for Dropdowns ===
// Purpose: Initializes Select2 for various dropdowns.
// Explanation: Unchanged, but included for completeness as it supports node description fields.

$(document).ready(function() {
    $('#select-inherit-1').select2({
        placeholder: "",
        allowClear: true,
        width: '100%'
    });

    $('#employee-inherit').select2({
        placeholder: "",
        allowClear: true,
        width: '100%'
    });

    $('#kpi-description-kpi123').select2({
        placeholder: "Select KPI",
        allowClear: true,
        width: '100%'
    });

    $('#deliverable-description-deliv123').select2({
        placeholder: "Select Deliverable",
        allowClear: true,
        width: '100%'
    });

    $('#evidence-description-evidence123').select2({
        placeholder: "Select Doc Evidence",
        allowClear: true,
        width: '100%'
    });
});







// === Employee Dropdown Population ===
// Purpose: Populates employee dropdowns based on employee code.
// Explanation: Unchanged, as it relates to employee selection, not node creation or password footers.
// Note: No password footer generation found here.

document.addEventListener('DOMContentLoaded', () => {
    const employeePasswordInput = document.getElementById('employee-password');
    const employeeDropdown = document.getElementById('employee-inherit');

    function clearDropdown() {
        employeeDropdown.innerHTML = '<option value="">Select Employee</option>';
    }

    function populateDropdown(employees) {
        clearDropdown();
        if (employees.length === 0) {
            const option = document.createElement('option');
            option.textContent = 'No employees found';
            option.disabled = true;
            employeeDropdown.appendChild(option);
            return;
        }
        employees.forEach(emp => {
            const option = document.createElement('option');
            option.value = emp.employee_code;
            option.textContent = emp.employee_name;
            employeeDropdown.appendChild(option);
        });
    }

    function fetchAndPopulate(code) {
        if (!code) {
            clearDropdown();
            return;
        }

        fetch(`/fetch_common_employees/?reports_to_code=${encodeURIComponent(code)}`)
            .then(res => res.json())
            .then(data => {
                if (data.matched_employees) {
                    populateDropdown(data.matched_employees);
                } else {
                    clearDropdown();
                }
            })
            .catch(() => clearDropdown());
    }

    const valueDescriptor = Object.getOwnPropertyDescriptor(HTMLInputElement.prototype, 'value');

    Object.defineProperty(employeePasswordInput, 'value', {
        set: function(val) {
            valueDescriptor.set.call(this, val);
            this.dispatchEvent(new Event('programmatic-change'));
        },
        get: function() {
            return valueDescriptor.get.call(this);
        }
    });

    employeePasswordInput.addEventListener('programmatic-change', (e) => {
        const code = e.target.value.trim();
        fetchAndPopulate(code);
    });

    employeePasswordInput.addEventListener('input', (e) => {
        const code = e.target.value.trim();
        fetchAndPopulate(code);
    });

    clearDropdown();
});

// === Employee and Company Code Handling ===
// Purpose: Fetches employee details and populates fields based on company and employee codes.
// Explanation: Unchanged, but included for completeness. No password footer generation found.

const companyCodeField = document.getElementById('company_code');
const departmentNameField = document.getElementById('department_name');
const reportsToCodeField = document.getElementById('employee-password');
const employeeSelect = document.getElementById('employee-select');
const selectedEmployeeInput = document.getElementById('selected-employee');

const companyCodeDescriptor = Object.getOwnPropertyDescriptor(HTMLInputElement.prototype, 'value');
Object.defineProperty(companyCodeField, 'value', {
    set: function(value) {
        companyCodeDescriptor.set.call(this, value);
        this.dispatchEvent(new Event('programmatic-change'));
    },
    get: function() {
        return companyCodeDescriptor.get.call(this);
    }
});

companyCodeField.addEventListener('programmatic-change', function () {
    const companyCode = companyCodeField.value.trim();
    const employeeCode = reportsToCodeField.value.trim();

    if (companyCode && employeeCode) {
        fetch(`/get_employee_details/?employee_code=${encodeURIComponent(employeeCode)}`)
            .then(response => response.json())
            .then(data => {
                if (!data.error) {
                    departmentNameField.value = data.department || '';
                    document.getElementById('position').value = data.position || '';
                    document.getElementById('company').value = data.company || '';
                    document.getElementById('country').value = data.country || '';
                    document.getElementById('headquarters').value = data.headquarters || '';
                } else {
                    console.warn('Employee details error:', data.error);
                }
            })
            .catch(error => console.error('Department fetch error:', error));
    }
});

function fetchEmployeeNames() {
    if (!reportsToCodeField.value.trim()) {
        employeeSelect.innerHTML = '<option value="" disabled selected>Select Employee</option>';
        $('#employee-select').select2('destroy').select2({
            placeholder: "Select Employee",
            allowClear: true,
            width: '23%',
            multiple: true
        });
        selectedEmployeeInput.value = '';
        return;
    }

    fetch(`http://127.0.0.1:8002/fetch_employee_names/?reports_to_code=${encodeURIComponent(reportsToCodeField.value)}`)
        .then(response => {
            if (!response.ok) throw new Error('No employees found');
            return response.json();
        })
        .then(data => {
            employeeSelect.innerHTML = '<option value="" disabled>Select Employee</option>';
            data.forEach(employeeName => {
                const option = document.createElement('option');
                option.value = employeeName;
                option.textContent = employeeName;
                employeeSelect.appendChild(option);
            });
            $('#employee-select').select2({
                placeholder: "Select Employee",
                allowClear: true,
                width: '23%',
                multiple: true
            });
            $('#employee-select').on('change', function() {
                const selectedValues = $(this).val();
                selectedEmployeeInput.value = selectedValues ? selectedValues.join(',') : '';
            });
        })
        .catch(error => {
            console.error('Fetch error:', error);
            employeeSelect.innerHTML = '<option value="" disabled selected>No employees found</option>';
            $('#employee-select').select2({
                placeholder: "Select Employee",
                allowClear: true,
                width: '23%',
                multiple: true
            });
            selectedEmployeeInput.value = '';
            showFeedback('Error fetching employees: ' + error.message, false);
        });
}

const reportsToDescriptor = Object.getOwnPropertyDescriptor(HTMLInputElement.prototype, 'value');
Object.defineProperty(reportsToCodeField, 'value', {
    set: function(value) {
        reportsToDescriptor.set.call(this, value);
        this.dispatchEvent(new Event('programmatic-change'));
    },
    get: function() {
        return reportsToDescriptor.get.call(this);
    }
});

reportsToCodeField.addEventListener('input', fetchEmployeeNames);
reportsToCodeField.addEventListener('programmatic-change', fetchEmployeeNames);
if (reportsToCodeField.value) fetchEmployeeNames();

document.addEventListener('DOMContentLoaded', function () {
    const employeePasswordField = document.getElementById('employee-password');
    const showPasswordCheckbox = document.getElementById('show-password');
    const formUsernameInput = document.getElementById('username-input');
    const navbarUsernameInput = document.getElementById('navbar-username-input');

    if (employeePasswordField) {
        employeePasswordField.addEventListener('blur', function () {
            const employeeCode = employeePasswordField.value.trim();
            if (employeeCode !== '') {
                fetch(`/get-active-login/?employee_code=${encodeURIComponent(employeeCode)}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            const username = data.data.username || '';
                            formUsernameInput.value = username;
                            if (navbarUsernameInput) {
                                navbarUsernameInput.value = username;
                            }
                            document.getElementById('region_branch').value = data.data.region_branch || '';
                            companyCodeField.value = data.data.company_code || '';
                            document.getElementById('branch_code').value = data.data.region_code || '';
                        } else {
                            console.error('Login error: ' + data.message);
                        }
                    })
                    .catch(error => console.error('Login fetch error:', error));
            }
        });
    }

    if (showPasswordCheckbox && employeePasswordField) {
        showPasswordCheckbox.addEventListener('change', function () {
            employeePasswordField.type = this.checked ? 'text' : 'password';
        });
    }
});

document.getElementById('show-password').addEventListener('change', function () {
    const passwordField = document.getElementById('employee-password');
    passwordField.type = this.checked ? 'text' : 'password';
});

// === Node and Tree Management ===
// Purpose: Manages the creation, editing, and display of nodes in a tree structure.
// Explanation: Core section with fixed refreshNodeDisplay function.
// Changes:
// - Headers: â€œStrategic Goalâ€, â€œKPIâ€, â€œDeliverableâ€, â€œDocument Evidenceâ€ via typeDisplayName.
// - Fixed: Corrected refreshNodeDisplay template literal syntax and header logic.
// - Removed "Edit" button from Strategic Goal nodes created after clicking "Initiate".

const NODE_TYPES = {
    STRATEGIC_GOAL: 'strategic_goal',
    KPI: 'kpi',
    DELIVERABLE: 'deliverable',
    EVIDENCE: 'evidence'
};

const KPI_COLORS = [
    '#e67e22', '#2ecc71', '#9b59b6', '#e74c3c',
    '#3498db', '#f1c40f', '#1abc9c', '#d35400'
];

let nodes = [];
let connections = [];
let colorIndex = 0;
let strategicGoalsData = [];

class Node {
    constructor(type, parentId = null, color = null, number = '') {
        this.id = Date.now().toString() + Math.random().toString(36).substr(2, 9);
        this.type = type;
        this.parentId = parentId;
        this.children = [];
        this.weight = '';
        this.dueDate = '';
        this.description = '';
        this.x = 0;
        this.y = 0;
        this.color = color;
        this.number = number;
        this.departments = [];
    }
}

function escapeHtml(unsafe) {
    return unsafe
        .replace(/&/g, '&')
        .replace(/</g, '<')
        .replace(/>/g, '>')
        .replace(/"/g, '"')
        .replace(/'/g, '');
}

function adjustNodeWidth(nodeEl, headerText) {
    const header = nodeEl.querySelector('.node-header');
    const tempSpan = document.createElement('span');
    tempSpan.style.fontSize = '12px';
    tempSpan.style.fontWeight = '600';
    tempSpan.style.letterSpacing = '0.5px';
    tempSpan.style.visibility = 'hidden';
    tempSpan.style.whiteSpace = 'normal';
    tempSpan.style.position = 'absolute';
    tempSpan.textContent = headerText;
    document.body.appendChild(tempSpan);
    const maxWidth = Math.max(300, tempSpan.offsetWidth + 40);
    document.body.removeChild(tempSpan);
    nodeEl.style.width = `${maxWidth}px`;
}

async function fetchStrategicGoals(companyCode) {
    if (!companyCode) return [];

    const url = `http://127.0.0.1:8002/retrieve_strategic_goals/?company_code=${encodeURIComponent(companyCode)}`;

    try {
        const response = await fetch(url);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const data = await response.json();

        if (data.status === 'success' && Array.isArray(data.goals)) {
            strategicGoalsData = data.goals;
            return [...new Set(data.goals.map(g => g.strategic_goal))];
        } else {
            console.warn('Unexpected data format:', data);
            return [];
        }
    } catch (error) {
        console.error('Failed to fetch strategic goals:', error);
        return [];
    }
}






async function createStrategicGoalForm() {
    if (nodes.some(n => n.type === NODE_TYPES.STRATEGIC_GOAL)) {
        alert('A Strategic Goal already exists.');
        return;
    }

    const companyCode = document.getElementById('company_code')?.value.trim();
    if (!companyCode) {
        alert('Company code is required.');
        return;
    }

    const uniqueGoals = await fetchStrategicGoals(companyCode);

    const form = document.createElement('div');
    form.className = 'strategic-goal-form';
    form.innerHTML = `
        <style>
            .strategic-goal-form {
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 80%;
                max-width: 600px;
                background-color: transparent;
                border: none;
                border-radius: 8px;
                box-shadow: none;
                z-index: 1050;
                padding: 20px;
            }
            
            /* Light theme */
            body.light-theme .strategic-goal-form .node-header,
            body.light-theme .strategic-goal-form .node-content,
            body.light-theme .strategic-goal-form .node-footer {
                background-color: rgba(255, 255, 255, 0.9);
            }
            
            /* Dark theme */
            body:not(.light-theme) .strategic-goal-form .node-header,
            body:not(.light-theme) .strategic-goal-form .node-content,
            body:not(.light-theme) .strategic-goal-form .node-footer {
                background-color: rgba(0, 0, 0, 0.9);
            }
            
            .select2-dropdown-custom .select2-results__option {
                color: white !important;
                background-color: black !important;
            }
            .select2-dropdown-custom .select2-results__option--highlighted {
                background-color: #333 !important;
                color: white !important;
            }
            .select2-container--default .select2-selection--single {
                border: none !important;
                background-color: transparent !important;
                box-shadow: none !important;
            }
        </style>
        <div class="strategic-goal-form" style="border:none !important;">
            <div class="node-header" style="text-align:center; border-radius: 8px 8px 0 0;">
                <h3>Select Strategic Goal <span class="node-number">1</span></h3>
            </div>
            <div class="node-content" style="border-radius: 0;">
                <div class="node-form">
                    <div class="form-group" style="margin-bottom: 5px; border:none;">
                        <label style="display: block; border:none; margin-bottom: 5px;">Strategic Goal:</label>
                        <select class="description-select" style="width: 100%; padding: 2px; border: none; background: transparent;">
                            ${uniqueGoals.map(goal => `<option value="${goal}">${goal}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group" style="margin-bottom: 5px; margin-top: 5px;">
                        <label class="label">
                            <i class="fas fa-weight-hanging"></i> Weight (%):
                        </label>
                        <input type="text" class="weight-display" readonly />
                        <div class="priority-indicator">
                            <span class="priority-dot"></span>
                            <span></span>
                        </div>
                    </div>
                    <div class="form-group" style="margin-bottom: 5px; margin-top: 5px;">
                        <label class="label">
                            <i class="far fa-calendar-alt"></i> Due Date:
                        </label>
                        <input type="text" class="due-date-display" readonly />
                    </div>
                    <div class="form-group" style="margin-bottom: 5px; margin-top: 5px;">
                        <label class="label">
                            <i class="fas fa-flag"></i> Goal Type:
                        </label>
                        <input type="text" class="priority-display" readonly />
                    </div>
                    <div class="form-group" style="margin-bottom: 5px; margin-top: 5px;">
                        <label class="label">
                            <i class="fas fa-users"></i> Inter-dependent Departments:
                        </label>
                        <div class="inter-dependent-list">
                            <span class="department-tag"><i class="fas fa-building"></i></span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="node-footer" style="border-radius: 0 0 8px 8px;">
                <button class="button delete-button" onclick="this.closest('.strategic-goal-form').remove(); document.getElementById('createStrategicGoal').disabled = false; document.body.classList.remove('no-scroll');">Cancel</button><i class="fas fa-times"></i>
                <button class="button" onclick="saveStrategicGoal(this)">Initiate</button><i class="fas fa-rocket"></i>
            </div>
        </div>
    `;

    document.body.appendChild(form);

    const descriptionSelect = form.querySelector('.description-select');
    const weightDisplay = form.querySelector('.weight-display');
    const dueDateDisplay = form.querySelector('.due-date-display');
    const priorityDisplay = form.querySelector('.priority-display');
    const departmentList = form.querySelector('.inter-dependent-list');
    

    $(descriptionSelect).select2({
        tags: true,
        width: '100%',
        placeholder: 'Select goal',
        allowClear: true,
        dropdownCssClass: 'select2-dropdown-custom'
    });

    $(descriptionSelect).on('change', function () {
        const selectedGoal = $(this).val();
        const matchingGoals = strategicGoalsData.filter(g => g.strategic_goal === selectedGoal);

        if (matchingGoals.length > 0) {
            const departments = [...new Set(matchingGoals.map(g => g.department).filter(Boolean))];
            const goalType = [...new Set(matchingGoals.map(g => g.goal_type).filter(Boolean))];
            weightDisplay.value = matchingGoals[0].weight ? `${Math.round(matchingGoals[0].weight * 100)}%` : '';
            dueDateDisplay.value = matchingGoals[0].due_date || '';
            priorityDisplay.value = goalType.join(', ') || '';
            departmentList.textContent = departments.length ? departments.join(', ') : '';
        } else {
            weightDisplay.value = '';
            dueDateDisplay.value = '';
            priorityDisplay.value = '';
            departmentList.textContent = '';
        }
    });

    document.getElementById('createStrategicGoal').disabled = true;
    document.body.classList.add('no-scroll');
}


function getStrategicGoalNumber() {
    const strategicGoals = nodes.filter(n => n.type === NODE_TYPES.STRATEGIC_GOAL);
    return strategicGoals.length + 1;
}

function getKpiNumber(strategicGoalId) {
    const kpis = nodes.filter(n => n.type === NODE_TYPES.KPI && n.parentId === strategicGoalId);
    return `${nodes.find(n => n.id === strategicGoalId).number}.${kpis.length + 1}`;
}

function getDeliverableNumber(kpiId) {
    const kpi = nodes.find(n => n.id === kpiId);
    const deliverables = nodes.filter(n => n.type === NODE_TYPES.DELIVERABLE && n.parentId === kpiId);
    return `${kpi.number}.${deliverables.length + 1}`;
}

function getDocEvidenceNumber(deliverableId) {
    const deliverable = nodes.find(n => n.id === deliverableId);
    const docEvidences = nodes.filter(n => n.type === NODE_TYPES.EVIDENCE && n.parentId === deliverableId);
    return `${deliverable.number}.${docEvidences.length + 1}`;
}

// Helper function to close all modals and overlays
function closeAllModals() {
    console.log('Running closeAllModals to clear overlays...');

    // Close Bootstrap modals
    ['inheritModal', 'assigneesModal', 'helpModal', 't_dateModal'].forEach(modalId => {
        const modalEl = document.getElementById(modalId);
        if (modalEl) {
            const modalInstance = bootstrap.Modal.getInstance(modalEl);
            if (modalInstance) {
                console.log(`Closing Bootstrap modal: ${modalId}`);
                modalInstance.hide();
            } else {
                console.log(`No Bootstrap instance for modal: ${modalId}, setting display to none`);
                modalEl.style.display = 'none';
            }
        }
    });

    // Explicitly hide modal-overlay
    const modalOverlay = document.getElementById('modal-overlay');
    if (modalOverlay) {
        console.log('Hiding #modal-overlay');
        modalOverlay.style.display = 'none';
    } else {
        console.log('#modal-overlay not found in DOM');
    }

    // Hide date picker container
    const datePickerContainer = document.getElementById('t_datePickerContainer');
    if (datePickerContainer) {
        console.log('Hiding #t_datePickerContainer');
        datePickerContainer.style.display = 'none';
    }

    // Remove Bootstrap modal backdrops
    const backdrops = document.querySelectorAll('.modal-backdrop');
    backdrops.forEach((backdrop, index) => {
        console.log(`Removing modal-backdrop #${index}`);
        backdrop.remove();
    });

    // Fallback: Remove any high z-index overlays
    const overlays = document.querySelectorAll('div[style*="z-index"], div[style*="background"]');
    overlays.forEach((overlay, index) => {
        const zIndex = parseInt(overlay.style.zIndex || 0);
        if (zIndex > 900 || overlay.style.background.includes('rgba') || overlay.style.backgroundColor.includes('rgba')) {
            console.log(`Removing potential overlay #${index}:`, overlay);
            overlay.style.display = 'none';
        }
    });

    // Restore body scroll and clean Bootstrap classes
    document.body.classList.remove('no-scroll', 'modal-open');
    document.body.style.overflow = 'auto';
    console.log('Body scroll restored, no-scroll and modal-open classes removed');
}

// Updated saveStrategicGoal function
function saveStrategicGoal(button) {
    console.log('saveStrategicGoal triggered for Initiate button');

    const form = button.closest('.strategic-goal-form');
    const descSelect = form.querySelector('.description-select');
    const descInput = descSelect.value || '';
    const weightDisplay = form.querySelector('.weight-display');
    const dueDateDisplay = form.querySelector('.due-date-display');
    const priorityDisplay = form.querySelector('.priority-display');
    const departmentList = form.querySelector('.inter-dependent-list');

    if (!descInput) {
        alert('Please select or enter a description.');
        return;
    }
    if (!weightDisplay.value) {
        alert('Please select a valid weight.');
        return;
    }
    if (!dueDateDisplay.value || dueDateDisplay.value === 'Not set') {
        alert('Please select a due date.');
        return;
    }
    if (!priorityDisplay.value) {
        alert('Please select a priority.');
        return;
    }

    const node = new Node(NODE_TYPES.STRATEGIC_GOAL, null, '#2ECC71', getStrategicGoalNumber());
    node.description = descInput;
    node.weight = weightDisplay.value.replace('%', '');
    node.dueDate = dueDateDisplay.value;
    node.priority = priorityDisplay.value;
    node.departments = departmentList.textContent === '(None)' ? [] : departmentList.textContent.split(', ');

    // Apply dueDate_all if set
    const dueDateAll = localStorage.getItem('dueDate_all');
    if (dueDateAll) {
        node.dueDate = dueDateAll;
    }

    const nodeEl = createNodeElement(node);
    nodeEl.classList.add('node-strategic-goal');
    nodeEl.style.top = '75px';
    nodeEl.style.left = '50%';
    nodeEl.style.transform = 'translateX(-50%)';
    node.x = nodeEl.offsetLeft;
    node.y = nodeEl.offsetTop;

    nodes.push(node);
    document.getElementById('container').appendChild(nodeEl);
    refreshNodeDisplay(node.id);

    const addBtn = nodeEl.querySelector('.button:not(.delete-button)');
    if (addBtn) {
        addBtn.style.backgroundColor = node.color;
        addBtn.onclick = () => {
            createChildNode(node.id, NODE_TYPES.KPI);
        };
    }

    // Debug: Log visible high z-index elements before cleanup
    const visibleOverlays = document.querySelectorAll('div[style*="z-index"], div[style*="background"]');
    console.log('Visible overlays before cleanup:', Array.from(visibleOverlays).map(el => ({
        id: el.id,
        class: el.className,
        zIndex: el.style.zIndex,
        display: el.style.display
    })));

    // Clean up all modals and overlays
    closeAllModals();

    // Additional check for modal-overlay
    const modalOverlay = document.getElementById('modal-overlay');
    if (modalOverlay && modalOverlay.style.display !== 'none') {
        console.log('Force hiding #modal-overlay again');
        modalOverlay.style.display = 'none';
    }

    // Remove the Strategic Goal form
    console.log('Removing strategic-goal-form');
    form.remove();

    // Re-enable the Start button
    document.getElementById('createStrategicGoal').disabled = false;
    console.log('Re-enabled #createStrategicGoal button');

    // Reposition the tree
    repositionTree();
    console.log('Tree repositioned');

    // Debug: Check for remaining overlays after cleanup
    const remainingOverlays = document.querySelectorAll('div[style*="z-index"], div[style*="background"]');
    console.log('Remaining overlays after cleanup:', Array.from(remainingOverlays).map(el => ({
        id: el.id,
        class: el.className,
        zIndex: el.style.zIndex,
        display: el.style.display
    })));
}

function createNodeElement(node) {
    const el = document.createElement('div');
    el.className = `node node-${node.type}`;
    el.id = node.id;
    if (node.color) {
        el.style.borderColor = node.color;
    }
    return el;
}

// Feedback Notification (prevents superimposition and includes accessibility)
function showFeedback(message, isSuccess) {
    // Remove any existing feedback elements
    const existingFeedback = document.querySelector('.feedback');
    if (existingFeedback) {
        existingFeedback.remove();
    }

    const feedbackEl = document.createElement('div');
    feedbackEl.className = `feedback ${isSuccess ? 'success' : 'error'}`;
    feedbackEl.innerHTML = message;
    feedbackEl.style.position = 'fixed';
    feedbackEl.style.top = '20px';
    feedbackEl.style.right = '20px';
    feedbackEl.style.padding = '10px';
    feedbackEl.style.backgroundColor = isSuccess ? '#4CAF50' : '#f44336';
    feedbackEl.style.color = 'white';
    feedbackEl.style.zIndex = '1000';
    feedbackEl.style.opacity = '1';
    feedbackEl.style.transition = 'opacity 0.5s';
    feedbackEl.setAttribute('role', 'alert');
    document.body.appendChild(feedbackEl);
    setTimeout(() => {
        feedbackEl.style.opacity = '0';
        setTimeout(() => feedbackEl.remove(), 500);
    }, 3000);
}



// Generate Node Form with Target and UoM for KPI and Deliverable Nodes
function getNodeForm(node) {
    const uniqueGoals = (typeof strategicGoalsData !== 'undefined')
        ? strategicGoalsData.map(g => g.strategic_goal)
        : [];

    let html;

    if (node.type === NODE_TYPES.EVIDENCE) {
        html = `
            <h4 class="node-header">${typeDisplayName(node.type)}<span class="node-number">${node.number}</span></h4>
            <div class="node-content">
                <div class="node-form">
                    <label class="label">Description:</label>
                    <div style="display: flex; gap: 10px; margin: 5px 0;">
                        <button class="button transversal-button" onclick="fetchDocumentEvidenceData('${node.id}', true);">Transversal</button>
                        <button class="button departmental-button" onclick="fetchDocumentEvidenceData('${node.id}', false);">Departmental</button>
                    </div>
                    <select class="description-select" id="dropdown-${node.id}">
                        <option value="${escapeHtml(node.description)}" selected>${escapeHtml(node.description)}</option>
                    </select>
                </div>
            </div>
            <div class="node-footer">
                <button class="button delete-button" onclick="cancelNodeCreation('${node.id}')">Cancel</button>
                <button class="button" onclick="saveNode(this, '${node.id}')">${node.description ? 'Save' : 'Create'}</button>
            </div>`;
    } else if (node.type === NODE_TYPES.STRATEGIC_GOAL) {
        html = `
            <h3 class="node-header">${typeDisplayName(node.type)}<span class="node-number">${node.number}</span></h3>
            <div class="node-content">
                <div class="node-form">
                    <label class="label">Strategic Goal:</label>
                    <select class="description-select" id="dropdown-${node.id}">
                        ${uniqueGoals.map(goal => `
                            <option value="${escapeHtml(goal)}"${node.description === goal ? ' selected' : ''}>
                                ${escapeHtml(goal)}
                            </option>`).join('')}
                    </select>
                    <label class="label">Weight (%):</label>
                    <select class="weight-select">
                        ${Array.from({ length: 21 }, (_, i) => `
                            <option value="${i * 5}"${node.weight == i * 5 ? ' selected' : ''}>
                                ${i * 5}%
                            </option>`).join('')}
                    </select>
                    <label class="label">Due Date:</label>
                    <input type="date" value="${node.dueDate || ''}" />
                    <label class="label">Inter-dependent Departments:</label>
                    <div class="inter-dependent-list">${node.departments?.length ? node.departments.join(', ') : '(None)'}</div>
                </div>
            </div>
            <div class="node-footer">
                <button class="button delete-button" onclick="cancelNodeCreation('${node.id}')">Cancel</button>
                <button class="button" onclick="saveNode(this, '${node.id}')">${node.description ? 'Save' : 'Create'}</button>
            </div>`;
    } else {
        const fetchFunction = node.type === NODE_TYPES.KPI ? 'fetchKPIData' : 'fetchDeliverableData';
        html = `
            <h4 class="node-header">${typeDisplayName(node.type)}<span class="node-number">${node.number}</span></h4>
            <div class="node-content">
                <div class="node-form">
                    <label class="label">Description:</label>
                    <div style="display: flex; gap: 10px; margin: 5px 0;">
                        <button class="button transversal-button" onclick="${fetchFunction}('${node.id}', true);">Transversal</button>
                        <button class="button departmental-button" onclick="${fetchFunction}('${node.id}', false);">Departmental</button>
                    </div>
                    <select class="description-select" id="dropdown-${node.id}">
                        <option value="${escapeHtml(node.description)}" selected>${escapeHtml(node.description)}</option>
                    </select>
                    <label class="label">Weight (%):</label>
                    <select class="weight-select">
                        ${Array.from({ length: 21 }, (_, i) => `
                            <option value="${i * 5}"${node.weight == i * 5 ? ' selected' : ''}>
                                ${i * 5}%
                            </option>`).join('')}
                    </select>
                    <label class="label">Target:</label>
                    <input type="number" step="any" class="target-input" value="${node.target || ''}" placeholder="Enter target value" />
                    <label class="label">Unit of Measure (UoM):</label>
                    <select class="uom-select">
                        <option value="" disabled${!node.uom ? ' selected' : ''}>Select UoM</option>
                        <option value="%"${node.uom === '%' ? ' selected' : ''}>%</option>
                        <option value="hours"${node.uom === 'hours' ? ' selected' : ''}>Hours</option>
                        <option value="units"${node.uom === 'units' ? ' selected' : ''}>Units</option>
                        <option value="count"${node.uom === 'count' ? ' selected' : ''}>Count</option>
                        <option value="score"${node.uom === 'score' ? ' selected' : ''}>Score</option>
                    </select>
                    <label class="label">Due Date:</label>
                    <input type="date" value="${node.dueDate || ''}" />
                </div>
            </div>
            <div class="node-footer">
                <button class="button delete-button" onclick="cancelNodeCreation('${node.id}')">Cancel</button>
                <button class="button" onclick="saveNode(this, '${node.id}')">${node.description ? 'Save' : 'Create'}</button>
            </div>`;
    }

    return html;
}






function handleDropdownFetch(nodeId, isTransversal) {
    const nodeElement = document.getElementById(nodeId);
    if (!nodeElement) {
        console.error(`Node with ID ${nodeId} not found`);
        return;
    }

    fetchKPIData(nodeId, isTransversal);
    fetchDeliverableData(nodeId, isTransversal);
    fetchDocumentEvidenceData(nodeId, isTransversal);
}

function initializeSelect2(nodeEl) {
    try {
        const select = $(nodeEl).find('.description-select');
        select.select2({
            tags: true,
            width: '100%',
            placeholder: 'Enter or select description',
            allowClear: true,
            dropdownCssClass: 'select2-dropdown-custom'
        });
    } catch (e) {
        console.error('Select2 initialization failed:', e);
    }
}

function cancelNodeCreation(nodeId) {
    const nodeEl = document.getElementById(nodeId);
    if (!nodeEl) return;

    const node = nodes.find(n => n.id === nodeId);
    if (!node) return;

    if (node.parentId) {
        const parentNode = nodes.find(n => n.id === node.parentId);
        if (parentNode) {
            parentNode.children = parentNode.children.filter(childId => childId !== nodeId);
        }
    }

    nodes = nodes.filter(n => n.id !== nodeId);
    nodeEl.remove();

    if (node.type === NODE_TYPES.STRATEGIC_GOAL) {
        document.getElementById('createStrategicGoal').disabled = false;
    }

    document.body.classList.remove('no-scroll');
    repositionTree();
}

function saveNode(button, nodeId) {
    const nodeEl = button.closest('.node');
    const nodeForm = button.closest('.node-form');
    const node = nodes.find(n => n.id === nodeId);
    if (!node) {
        alert('Node not found.');
        return;
    }
    const nodeType = node.type; // Use node.type from nodes array

    // Retrieve common fields
    const descSelect = nodeForm.querySelector('.description-select');
    const description = descSelect.value || '';
    if (!description) {
        alert('Please select or enter a description.');
        return;
    }

    // Initialize nodeData for logging and potential backend saving
    const nodeData = {
        id: nodeId,
        type: nodeType,
        description
    };

    if (nodeType === NODE_TYPES.EVIDENCE) {
        // Evidence nodes only need description
        node.description = description;
    } else {
        // Handle KPI, Deliverable, and Strategic Goal nodes
        const weightSelect = nodeForm.querySelector('.weight-select');
        const dueDateInput = nodeForm.querySelector('input[type="date"]');
        
        if (!weightSelect || weightSelect.value === '') {
            alert('Please select a valid weight.');
            return;
        }
        if (!dueDateInput || !dueDateInput.value) {
            alert('Please enter a due date.');
            return;
        }

        node.description = description;
        node.weight = parseFloat(weightSelect.value); // Ensure weight is a number
        node.dueDate = dueDateInput.value;
        nodeData.weight = node.weight;
        nodeData.dueDate = node.dueDate;

        if (nodeType === NODE_TYPES.STRATEGIC_GOAL) {
            const departmentList = nodeForm.querySelector('.inter-dependent-list');
            node.departments = departmentList.textContent === '(None)' ? [] : departmentList.textContent.split(', ');
            nodeData.departments = node.departments;
        } else if (nodeType === NODE_TYPES.KPI || nodeType === NODE_TYPES.DELIVERABLE) {
            const targetInput = nodeForm.querySelector('.target-input');
            const uomSelect = nodeForm.querySelector('.uom-select');
            
            if (!targetInput || targetInput.value === '') {
                alert('Please enter a valid target value.');
                return;
            }
            if (!uomSelect || !uomSelect.value) {
                alert('Please select a unit of measure.');
                return;
            }

            node.target = parseFloat(targetInput.value); // Ensure target is a number/float
            node.uom = uomSelect.value;
            nodeData.target = node.target;
            nodeData.uom = node.uom;
        }
    }

    console.log('Saving node:', nodeData); // Log for debugging

    // Update UI and reset scroll
    refreshNodeDisplay(nodeId);
    document.body.classList.remove('no-scroll');

    // Optional: Add logic to save nodeData to backend
    // Example: fetch('/save-node', { method: 'POST', body: JSON.stringify(nodeData) });
}

function editNode(nodeId) {
    const node = nodes.find(n => n.id === nodeId);
    const nodeEl = document.getElementById(nodeId);
    if (!node || !nodeEl) {
        console.error('Node or element not found:', nodeId);
        return;
    }
    nodeEl.innerHTML = getNodeForm(node);
    initializeSelect2(nodeEl);
    const saveBtn = nodeEl.querySelector('.button:not(.delete-button)');
    if (saveBtn) saveBtn.style.backgroundColor = node.color;
    document.body.classList.add('no-scroll');
}

function deleteNode(nodeId) {
    const node = nodes.find(n => n.id === nodeId);
    if (!node) return;
    if (node.type === NODE_TYPES.STRATEGIC_GOAL && nodes.some(n => n.parentId === nodeId)) {
        alert('Cannot delete the Strategic Goal while it has KPIs.');
        return;
    }
    function removeNodeAndChildren(id) {
        const node = nodes.find(n => n.id === id);
        if (!node) return;
        node.children.slice().forEach(childId => removeNodeAndChildren(childId));
        if (node.parentId) {
            const parentNode = nodes.find(n => n.id === node.parentId);
            if (parentNode) {
                parentNode.children = parentNode.children.filter(childId => childId !== id);
            }
        }
        const nodeEl = document.getElementById(id);
        if (nodeEl) nodeEl.remove();
        nodes = nodes.filter(n => n.id !== id);
    }
    removeNodeAndChildren(nodeId);
    if (node.type === NODE_TYPES.STRATEGIC_GOAL) {
        document.getElementById('createStrategicGoal').disabled = false;
    }
    repositionTree();
}

// Display Type Name (unchanged)
function typeDisplayName(type) {
    switch (type) {
        case NODE_TYPES.STRATEGIC_GOAL: return 'Strategic Goal';
        case NODE_TYPES.KPI: return 'KPI';
        case NODE_TYPES.DELIVERABLE: return 'Deliverable';
        case NODE_TYPES.EVIDENCE: return 'Document Evidence';
        default: return '';
    }
}

// Get Child Buttons (unchanged)
function getChildButtons(node) {
    if (node.type === NODE_TYPES.EVIDENCE) return '';
    let btnText = '';
    if (node.type === NODE_TYPES.STRATEGIC_GOAL) btnText = 'Create KPI';
    else if (node.type === NODE_TYPES.KPI) btnText = 'Create Deliverable';
    else if (node.type === NODE_TYPES.DELIVERABLE) btnText = 'Create Doc Evidence';
    return `<button class="button" onclick="createChildNode('${node.id}', '${node.type === NODE_TYPES.STRATEGIC_GOAL ? NODE_TYPES.KPI : node.type === NODE_TYPES.KPI ? NODE_TYPES.DELIVERABLE : NODE_TYPES.EVIDENCE}')">${btnText}</button>`;
}

// Create Child Node (unchanged)
function createChildNode(parentId, childType) {
    const parentNode = nodes.find(n => n.id === parentId);
    if (!parentNode) return;
    const childColor = childType === NODE_TYPES.KPI ? KPI_COLORS[colorIndex % KPI_COLORS.length] : parentNode.color;
    if (childType === NODE_TYPES.KPI) colorIndex++;
    addChildNode(parentNode, childType, childColor);
}

// Add Child Node (unchanged)
function addChildNode(parentNode, type, color) {
    const childNode = new Node(type, parentNode.id, color);
    if (type === NODE_TYPES.KPI) {
        childNode.number = getKpiNumber(parentNode.id);
    } else if (type === NODE_TYPES.DELIVERABLE) {
        childNode.number = getDeliverableNumber(parentNode.id);
    } else if (type === NODE_TYPES.EVIDENCE) {
        childNode.number = getDocEvidenceNumber(parentNode.id);
    }
    parentNode.children.push(childNode.id);
    const childEl = createNodeElement(childNode);
    childEl.innerHTML = getNodeForm(childNode);
    const saveBtn = childEl.querySelector('.button:not(.delete-button)');
    if (saveBtn) saveBtn.style.backgroundColor = color;
    document.getElementById('container').appendChild(childEl);
    nodes.push(childNode);
    initializeSelect2(childEl);
    const parentEl = document.getElementById(parentNode.id);
    if (parentEl) {
        childNode.x = parentEl.offsetLeft;
        childNode.y = parentEl.offsetTop + parentEl.offsetHeight + 37.8;
        childEl.style.left = `${childNode.x}px`;
        childEl.style.top = `${childNode.y}px`;
    }
    repositionTree();
    drawConnection(parentNode.id, childNode.id);
    document.body.classList.add('no-scroll');
}

// Save Node (merged from previous responses)
function saveNode(button, nodeId) {
    const nodeEl = button.closest('.node');
    const nodeForm = button.closest('.node-form');
    const node = nodes.find(n => n.id === nodeId);
    if (!node) {
        alert('Node not found.');
        return;
    }
    const nodeType = node.type;

    // Retrieve common fields
    const descSelect = nodeForm.querySelector('.description-select');
    const description = descSelect.value || '';
    if (!description) {
        alert('Please select or enter a description.');
        return;
    }

    // Initialize nodeData for logging and potential backend saving
    const nodeData = {
        id: nodeId,
        type: nodeType,
        description
    };

    if (nodeType === NODE_TYPES.EVIDENCE) {
        // Evidence nodes only need description
        node.description = description;
    } else {
        // Handle KPI, Deliverable, and Strategic Goal nodes
        const weightSelect = nodeForm.querySelector('.weight-select');
        const dueDateInput = nodeForm.querySelector('input[type="date"]');
        
        if (!weightSelect || weightSelect.value === '') {
            alert('Please select a valid weight.');
            return;
        }
        if (!dueDateInput || !dueDateInput.value) {
            alert('Please enter a due date.');
            return;
        }

        node.description = description;
        node.weight = parseFloat(weightSelect.value);
        node.dueDate = dueDateInput.value;
        nodeData.weight = node.weight;
        nodeData.dueDate = node.dueDate;

        if (nodeType === NODE_TYPES.STRATEGIC_GOAL) {
            const departmentList = nodeForm.querySelector('.inter-dependent-list');
            node.departments = departmentList.textContent === '(None)' ? [] : departmentList.textContent.split(', ');
            nodeData.departments = node.departments;
        } else if (nodeType === NODE_TYPES.KPI || nodeType === NODE_TYPES.DELIVERABLE) {
            const targetInput = nodeForm.querySelector('.target-input');
            const uomSelect = nodeForm.querySelector('.uom-select');
            
            if (!targetInput || targetInput.value === '') {
                alert('Please enter a valid target value.');
                return;
            }
            if (!uomSelect || !uomSelect.value) {
                alert('Please select a unit of measure.');
                return;
            }

            node.target = parseFloat(targetInput.value);
            node.uom = uomSelect.value;
            nodeData.target = node.target;
            nodeData.uom = node.uom;
        }
    }

    console.log('Saving node:', nodeData);

    // Update UI and reset scroll
    refreshNodeDisplay(nodeId);
    document.body.classList.remove('no-scroll');

    // Optional: Save to backend
    // fetch('/save-node', { method: 'POST', body: JSON.stringify(nodeData) });
}

// Refresh Node Display (updated to show target and uom)
function refreshNodeDisplay(nodeId) {
    const node = nodes.find(n => n.id === nodeId);
    const nodeEl = document.getElementById(nodeId);
    if (!node || !nodeEl) return;

    const headerText = typeDisplayName(node.type);
    let html;

    if (node.type === NODE_TYPES.EVIDENCE) {
        html = `
            <h4 class="node-header">${escapeHtml(headerText)}<span class="node-number">${node.number}</span></h4>
            <div class="node-content">
                <p>${escapeHtml(node.description)}</p>
            </div>
            <div class="node-footer">${getChildButtons(node)}
                <button class="button edit-button" onclick="editNode('${node.id}')">Edit</button>
                <button class="button delete-button" onclick="deleteNode('${node.id}')">Delete</button>
            </div>`;
    } else if (node.type === NODE_TYPES.STRATEGIC_GOAL) {
        html = `
            <h3 class="node-header">${escapeHtml(headerText)}<span class="node-number">${node.number}</span></h3>
            <div class="node-content">
                <p>${escapeHtml(node.description)}</p>
                <p><strong>Weight:</strong> ${node.weight}%</p>
                <p><strong>Due Date:</strong> ${formatDateForDisplay(node.dueDate)}</p>
                ${node.departments.length ? `<p><strong>Departments:</strong> ${node.departments.join(', ')}</p>` : ''}
            </div>
            <div class="node-footer">${getChildButtons(node)}
                <button class="button delete-button" onclick="deleteNode('${node.id}')">Delete</button>
            </div>`;
    } else {
        // KPI and Deliverable nodes
        html = `
            <h4 class="node-header">${escapeHtml(headerText)}<span class="node-number">${node.number}</span></h4>
            <div class="node-content">
                <p>${escapeHtml(node.description)}</p>
                <p><strong>Weight:</strong> ${node.weight}%</p>
                <p><strong>Target:</strong> ${node.target !== undefined ? node.target : 'Not set'} ${node.uom || ''}</p>
                <p><strong>Due Date:</strong> ${formatDateForDisplay(node.dueDate)}</p>
            </div>
            <div class="node-footer">${getChildButtons(node)}
                <button class="button edit-button" onclick="editNode('${node.id}')">Edit</button>
                <button class="button delete-button" onclick="deleteNode('${node.id}')">Delete</button>
            </div>`;
    }

    nodeEl.innerHTML = html;
    adjustNodeWidth(nodeEl, headerText);
    const addBtn = nodeEl.querySelector('.button:not(.edit-button):not(.delete-button)');
    if (addBtn) {
        addBtn.style.backgroundColor = node.color;
    }
}

function drawConnection(parentId, childId) {
    const connection = { parentId, childId };
    connections.push(connection);
    console.log(`Drawing connection from ${parentId} to ${childId}`);
    // Implement actual connection drawing (e.g., using SVG or Canvas)
}

function repositionTree() {
    console.log('Repositioning tree...');
    // Implement tree layout logic (e.g., using D3.js or manual positioning)
}


function createNodeElement(node) {
    const el = document.createElement('div');
    el.className = `node node-${node.type}`;
    el.id = node.id;
    if (node.color) {
        el.style.borderColor = node.color;
    }
    return el;
}

function initializeSelect2(nodeEl) {
    try {
        const select = $(nodeEl).find('.description-select');
        select.select2({
            tags: true,
            width: '100%',
            placeholder: 'Enter or select description',
            allowClear: true
        });
    } catch (e) {
        console.error('Select2 initialization failed:', e);
    }
}

function cancelNodeCreation(nodeId) {
    const nodeEl = document.getElementById(nodeId);
    if (!nodeEl) return;

    const node = nodes.find(n => n.id === nodeId);
    if (!node) return;

    if (node.parentId) {
        const parentNode = nodes.find(n => n.id === node.parentId);
        if (parentNode) {
            parentNode.children = parentNode.children.filter(childId => childId !== nodeId);
        }
    }

    nodes = nodes.filter(n => n.id !== nodeId);
    nodeEl.remove();

    if (node.type === NODE_TYPES.STRATEGIC_GOAL) {
        document.getElementById('createStrategicGoal').disabled = false;
    }

    document.body.classList.remove('no-scroll');
    repositionTree();
}

function saveNode(button, nodeId) {
    const nodeEl = button.closest('.node');
    const node = nodes.find(n => n.id === nodeId);
    const descSelect = nodeEl.querySelector('.description-select');
    const descInput = descSelect.value || '';
    if (!descInput) {
        alert('Please select or enter a description.');
        return;
    }

    if (node.type === NODE_TYPES.EVIDENCE) {
        node.description = descInput;
    } else {
        const weightInput = nodeEl.querySelector('.weight-select');
        const dateInput = nodeEl.querySelector('input[type="date"]');
        if (!weightInput || weightInput.value === '') {
            alert('Please select a valid weight.');
            return;
        }
        if (!dateInput || dateInput.value === '') {
            alert('Please enter a due date.');
            return;
        }
        node.description = descInput;
        node.weight = weightInput.value;
        node.dueDate = dateInput.value;
    }

    const headerText = typeDisplayName(node.type);
    let html;
    if (node.type === NODE_TYPES.EVIDENCE) {
        html = `<h4 class="node-header">${escapeHtml(headerText)}<span class="node-number">${node.number}</span></h4>
            <div class="node-content">
                <p>${escapeHtml(node.description)}</p>
            </div>
            <div class="node-footer">${getChildButtons(node)}
                <button class="button edit-button" onclick="editNode('${node.id}')">Edit</button>
                <button class="button delete-button" onclick="deleteNode('${node.id}')">Delete</button>
            </div>`;
    } else {
        html = `<h${node.type === NODE_TYPES.STRATEGIC_GOAL ? 3 : 4} class="node-header">${escapeHtml(headerText)}<span class="node-number">${node.number}</span></h${node.type === NODE_TYPES.STRATEGIC_GOAL ? 3 : 4}>
            <div class="node-content">
                <p>${escapeHtml(node.description)}</p>
                <p><strong>Weight:</strong> ${node.weight}%</p>
                <p><strong>Due Date:</strong> ${node.dueDate}</p>
            </div>
            <div class="node-footer">${getChildButtons(node)}
                <button class="button edit-button" onclick="editNode('${node.id}')">Edit</button>
                <button class="button delete-button" onclick="deleteNode('${node.id}')">Delete</button>
            </div>`;
    }

    nodeEl.innerHTML = html;
    adjustNodeWidth(nodeEl, headerText);
    const addBtn = nodeEl.querySelector('.button:not(.edit-button):not(.delete-button)');
    if (addBtn) {
        addBtn.style.backgroundColor = node.color;
        addBtn.onclick = () => {
            let childType, childColor;
            if (node.type === NODE_TYPES.STRATEGIC_GOAL) {
                childType = NODE_TYPES.KPI;
                childColor = KPI_COLORS[colorIndex % KPI_COLORS.length];
                colorIndex++;
            } else if (node.type === NODE_TYPES.KPI) {
                childType = NODE_TYPES.DELIVERABLE;
                childColor = node.color;
            } else if (node.type === NODE_TYPES.DELIVERABLE) {
                childType = NODE_TYPES.EVIDENCE;
                childColor = node.color;
            }
            if (childType) {
                addChildNode(node, childType, childColor);
            }
        };
    }
    const contentEl = nodeEl.querySelector('.node-content');
    if (contentEl) {
        contentEl.scrollTop = 0;
    }
    repositionTree();
    document.body.classList.remove('no-scroll');
}

function editNode(nodeId) {
    const node = nodes.find(n => n.id === nodeId);
    const nodeEl = document.getElementById(nodeId);
    if (!node || !nodeEl) {
        console.error('Node or element not found:', nodeId);
        return;
    }
    nodeEl.innerHTML = getNodeForm(node);
    initializeSelect2(nodeEl);
    const saveBtn = nodeEl.querySelector('.button:not(.delete-button)');
    if (saveBtn) saveBtn.style.backgroundColor = node.color;
    document.body.classList.add('no-scroll');
}

function deleteNode(nodeId) {
    const node = nodes.find(n => n.id === nodeId);
    if (!node) return;
    if (node.type === NODE_TYPES.STRATEGIC_GOAL && nodes.some(n => n.parentId === nodeId)) {
        alert('Cannot delete the Strategic Goal while it has KPIs.');
        return;
    }
    function removeNodeAndChildren(id) {
        const node = nodes.find(n => n.id === id);
        if (!node) return;
        node.children.slice().forEach(childId => removeNodeAndChildren(childId));
        if (node.parentId) {
            const parentNode = nodes.find(n => n.id === node.parentId);
            if (parentNode) {
                parentNode.children = parentNode.children.filter(childId => childId !== id);
            }
        }
        const nodeEl = document.getElementById(id);
        if (nodeEl) nodeEl.remove();
        nodes = nodes.filter(n => n.id !== id);
    }
    removeNodeAndChildren(nodeId);
    if (node.type === NODE_TYPES.STRATEGIC_GOAL) {
        document.getElementById('createStrategicGoal').disabled = false;
    }
    repositionTree();
    document.body.classList.remove('no-scroll');
}

function typeDisplayName(type) {
    switch(type) {
        case NODE_TYPES.STRATEGIC_GOAL: return 'Strategic Goal';
        case NODE_TYPES.KPI: return 'KPI';
        case NODE_TYPES.DELIVERABLE: return 'Deliverable';
        case NODE_TYPES.EVIDENCE: return 'Document Evidence';
        default: return '';
    }
}

function getChildButtons(node) {
    if (node.type === NODE_TYPES.EVIDENCE) return '';
    let btnText = '';
    if (node.type === NODE_TYPES.STRATEGIC_GOAL) btnText = 'Create KPI';
    else if (node.type === NODE_TYPES.KPI) btnText = 'Create Deliverable';
    else if (node.type === NODE_TYPES.DELIVERABLE) btnText = 'Create Doc Evidence';
    return `<button class="button">${btnText}</button>`;
}

function addChildNode(parentNode, type, color) {
    const childNode = new Node(type, parentNode.id, color);
    if (type === NODE_TYPES.KPI) {
        childNode.number = getKpiNumber(parentNode.id);
    } else if (type === NODE_TYPES.DELIVERABLE) {
        childNode.number = getDeliverableNumber(parentNode.id);
    } else if (type === NODE_TYPES.EVIDENCE) {
        childNode.number = getDocEvidenceNumber(parentNode.id);
    }
    parentNode.children.push(childNode.id);
    const childEl = createNodeElement(childNode);
    childEl.innerHTML = getNodeForm(childNode);
    const saveBtn = childEl.querySelector('.button:not(.delete-button)');
    if (saveBtn) saveBtn.style.backgroundColor = color;
    document.getElementById('container').appendChild(childEl);
    nodes.push(childNode);
    initializeSelect2(childEl);
    const parentEl = document.getElementById(parentNode.id);
    if (parentEl) {
        childNode.x = parentEl.offsetLeft;
        childNode.y = parentEl.offsetTop + parentEl.offsetHeight + 37.8;
        childEl.style.left = `${childNode.x}px`;
        childEl.style.top = `${childNode.y}px`;
    }
    repositionTree();
    drawConnection(parentNode.id, childNode.id);
    document.body.classList.add('no-scroll');
}

// === Date Modal Functions ===
// Purpose: Saves t_datePicker input to local storage on t_confirmDate click, updates displays.
// Explanation: Local storage values set modal displays on load; t_datePicker starts empty.

// Format date for display (YYYY-MM-DD to YYYY/MM/DD)
function formatDateForDisplay(dateStr) {
    if (!dateStr || typeof dateStr !== 'string') return 'Not set';
    return dateStr.replace(/-/g, '/');
}





// Save due date to local storage and update UI
function saveDueDateToLocalStorage(dateType, newDate = null) {
    const formattedDate = newDate ? formatDateForDisplay(newDate) : 'Not set';
    let displayElId;
    let cellIndex = null;

    switch (dateType) {
        case 'kp1':
            if (newDate) {
                localStorage.setItem('dueDate_kp1', newDate);
            } else {
                localStorage.removeItem('dueDate_kp1');
            }
            displayElId = 't_kp1-display';
            cellIndex = 8; // KPI Due Date column
            break;
        case 'deliverable':
            if (newDate) {
                localStorage.setItem('dueDate_deliverable', newDate);
            } else {
                localStorage.removeItem('dueDate_deliverable');
            }
            displayElId = 't_deliverable-display';
            cellIndex = 12; // Deliverable Due Date column
            break;
        case 'document':
            if (newDate) {
                localStorage.setItem('dueDate_document', newDate);
            } else {
                localStorage.removeItem('dueDate_document');
            }
            displayElId = 't_document-display';
            break;
        case 'all':
            if (newDate) {
                localStorage.setItem('dueDate_all', newDate);
                localStorage.setItem('dueDate_kp1', newDate);
                localStorage.setItem('dueDate_deliverable', newDate);
                localStorage.setItem('dueDate_document', newDate);
            } else {
                localStorage.removeItem('dueDate_all');
                localStorage.removeItem('dueDate_kp1');
                localStorage.removeItem('dueDate_deliverable');
                localStorage.removeItem('dueDate_document');
            }
            const displays = ['t_kp1-display', 't_deliverable-display', 't_document-display', 't_all-display'];
            displays.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.textContent = newDate ? formattedDate : id === 't_all-display' ? 'Set all' : 'Not set';
            });
            document.querySelectorAll('#data-table tbody tr').forEach(row => {
                if (row.cells[8]) row.cells[8].textContent = newDate ? formattedDate : 'Not set'; // KPI
                if (row.cells[12]) row.cells[12].textContent = newDate ? formattedDate : 'Not set'; // Deliverable
            });
            displayElId = 't_all-display';
            break;
        default:
            return;
    }

    if (dateType !== 'all') {
        const displayEl = document.getElementById(displayElId);
        if (displayEl) {
            displayEl.textContent = newDate ? formattedDate : 'Not set';
            if (newDate) displayEl.style.backgroundColor = '#2ecc71';
        }
        if (cellIndex !== null) {
            document.querySelectorAll('#data-table tbody tr').forEach(row => {
                if (row.cells[cellIndex]) {
                    row.cells[cellIndex].textContent = newDate ? formattedDate : 'Not set';
                }
            });
        }
    }

    applyStoredDueDates();
}

function applyStoredDueDates() {
    const dueDateAll = localStorage.getItem('dueDate_all');
    const dueDateKp1 = localStorage.getItem('dueDate_kp1');
    const dueDateDeliverable = localStorage.getItem('dueDate_deliverable');
    const dueDateDoc = localStorage.getItem('dueDate_document');

    // Update modal displays from local storage
    document.getElementById('t_kp1-display').textContent = formatDateForDisplay(dueDateKp1);
    document.getElementById('t_deliverable-display').textContent = formatDateForDisplay(dueDateDeliverable);
    document.getElementById('t_document-display').textContent = formatDateForDisplay(dueDateDoc);
    document.getElementById('t_all-display').textContent = dueDateAll ? formatDateForDisplay(dueDateAll) : 'Set all';

    // Update nodes
    nodes.forEach(node => {
        if (dueDateAll) {
            node.dueDate = dueDateAll;
        } else {
            switch (node.type) {
                case NODE_TYPES.KPI:
                    if (dueDateKp1) node.dueDate = dueDateKp1;
                    break;
                case NODE_TYPES.DELIVERABLE:
                    if (dueDateDeliverable) node.dueDate = dueDateDeliverable;
                    break;
                case NODE_TYPES.EVIDENCE:
                    if (dueDateDoc) node.dueDate = dueDateDoc;
                    break;
                case NODE_TYPES.STRATEGIC_GOAL:
                    // Only updated by 'all'
                    break;
            }
        }
        refreshNodeDisplay(node.id);
    });

    repositionTree();
}





function refreshNodeDisplay(nodeId) {
    const node = nodes.find(n => n.id === nodeId);
    const nodeEl = document.getElementById(nodeId);
    if (!node || !nodeEl) return;

    const headerText = typeDisplayName(node.type);
    let html;

    if (node.type === NODE_TYPES.EVIDENCE) {
        html = `
            <h4 class="node-header">${escapeHtml(headerText)}<span class="node-number">${node.number}</span></h4>
            <div class="node-content">
                <p>${escapeHtml(node.description)}</p>
            </div>
            <div class="node-footer">${getChildButtons(node)}
                <button class="button edit-button" onclick="editNode('${node.id}')">Edit</button>
                <button class="button delete-button" onclick="deleteNode('${node.id}')">Delete</button>
            </div>`;
    } else if (node.type === NODE_TYPES.STRATEGIC_GOAL) {
        html = `
            <h3 class="node-header">${escapeHtml(headerText)}<span class="node-number">${node.number}</span></h3>
            <div class="node-content">
                <p>${escapeHtml(node.description)}</p>
                <p><strong>Weight:</strong> ${node.weight}%</p>
                <p><strong>Due Date:</strong> ${formatDateForDisplay(node.dueDate)}</p>
                ${node.departments.length ? `<p><strong>Departments:</strong> ${node.departments.join(', ')}</p>` : ''}
            </div>
            <div class="node-footer">${getChildButtons(node)}
                <button class="button delete-button" onclick="deleteNode('${node.id}')">Delete</button>
            </div>`;
    } else {
        // KPI and Deliverable nodes
        html = `
            <h4 class="node-header">${escapeHtml(headerText)}<span class="node-number">${node.number}</span></h4>
            <div class="node-content">
                <p>${escapeHtml(node.description)}</p>
                <p><strong>Weight:</strong> ${node.weight}%</p>
                <p><strong>Target:</strong> ${node.target !== undefined ? node.target : 'Not set'} ${node.uom || ''}</p>
                <p><strong>Due Date:</strong> ${formatDateForDisplay(node.dueDate)}</p>
            </div>
            <div class="node-footer">${getChildButtons(node)}
                <button class="button edit-button" onclick="editNode('${node.id}')">Edit</button>
                <button class="button delete-button" onclick="deleteNode('${node.id}')">Delete</button>
            </div>`;
    }

    nodeEl.innerHTML = html;
    adjustNodeWidth(nodeEl, headerText);
    const addBtn = nodeEl.querySelector('.button:not(.edit-button):not(.delete-button)');
    if (addBtn) {
        addBtn.style.backgroundColor = node.color;
    }
}


function initializeDateModal() {
    const dateButtons = document.querySelectorAll('.t_btn-date-option');
    const datePickerContainer = document.getElementById('t_datePickerContainer');
    const datePicker = document.getElementById('t_datePicker');
    const datePickerTitle = document.getElementById('t_datePickerTitle');
    const confirmDateBtn = document.getElementById('t_confirmDate');
    const cancelDateBtn = document.getElementById('t_cancelDate');
    let currentDateType = '';

    dateButtons.forEach(button => {
        button.addEventListener('click', () => {
            currentDateType = button.getAttribute('data-date-type');
            datePickerTitle.textContent = `Select ${button.textContent.trim()} due date`;
            datePickerContainer.style.display = 'block';
            datePicker.value = ''; // Start empty
        });
    });

confirmDateBtn.addEventListener('click', () => {
    const selectedDate = datePicker.value;
    if (!selectedDate) {
        // Check if user wants to clear the date
        if (confirm('Do you want to clear the date?')) {
            saveDueDateToLocalStorage(currentDateType, null);
        }
    } else {
        saveDueDateToLocalStorage(currentDateType, selectedDate);
    }
    datePickerContainer.style.display = 'none';
    datePicker.value = '';
});

    cancelDateBtn.addEventListener('click', () => {
        datePickerContainer.style.display = 'none';
        datePicker.value = '';
    });

    // Initialize modal displays from local storage
    applyStoredDueDates();
}




function closeDateModal() {
    const datePickerContainer = document.getElementById('t_datePickerContainer');
    datePickerContainer.style.display = 'none';
    $('#t_dateModal').modal('hide');
}







// Initialize on page load
document.addEventListener('DOMContentLoaded', () => {
    initializeDateModal();
});

function repositionTree() {
    const container = document.getElementById('container');
    const roots = nodes.filter(n => !n.parentId);
    let currentTop = 75;
    roots.forEach(root => {
        const rootEl = document.getElementById(root.id);
        if (!rootEl) {
            console.error('Root element not found:', root.id);
            return;
        }
        rootEl.style.top = `${currentTop}px`;
        rootEl.style.left = `${(container.offsetWidth - rootEl.offsetWidth) / 2}px`;
        currentTop = positionLevel([root], currentTop + rootEl.offsetHeight + 37.8);
    });
    updateConnections();
    adjustContainerSize();
}

function positionLevel(nodesAtLevel, top) {
    const container = document.getElementById('container');
    const spacingX = 40;
    const spacingY = 37.8;
    let totalWidth = -spacingX;
    const nodeSizes = [];
    nodesAtLevel.forEach(node => {
        const el = document.getElementById(node.id);
        if (el && node.type !== NODE_TYPES.STRATEGIC_GOAL) {
            const width = el.offsetWidth;
            const height = el.offsetHeight;
            nodeSizes.push({ width, height });
            totalWidth += width + spacingX;
        } else {
            nodeSizes.push({ width: 0, height: 0 });
        }
    });
    const containerWidth = container.offsetWidth;
    let left = (containerWidth - totalWidth) / 2;
    let maxHeight = 0;
    nodesAtLevel.forEach((node, i) => {
        const el = document.getElementById(node.id);
        if (!el || node.type === NODE_TYPES.STRATEGIC_GOAL) return;
        el.style.top = `${top}px`;
        el.style.left = `${left}px`;
        node.x = left;
        node.y = top;
        left += nodeSizes[i].width + spacingX;
        if (nodeSizes[i].height > maxHeight) {
            maxHeight = nodeSizes[i].height;
        }
    });
    let nextLevelNodes = [];
    nodesAtLevel.forEach(node => {
        node.children.forEach(childId => {
            const childNode = nodes.find(n => n.id === childId);
            if (childNode) nextLevelNodes.push(childNode);
        });
    });
    if (nextLevelNodes.length === 0) return top + maxHeight + spacingY;
    return positionLevel(nextLevelNodes, top + maxHeight + spacingY);
}

function adjustContainerSize() {
    const container = document.getElementById('container');
    let minX = 0;
    let maxX = 0;
    let maxY = 0;
    nodes.forEach(node => {
        const el = document.getElementById(node.id);
        if (el) {
            const left = el.offsetLeft;
            const right = left + el.offsetWidth;
            const bottom = el.offsetTop + el.offsetHeight;
            if (left < minX) minX = left;
            if (right > maxX) maxX = right;
            if (bottom > maxY) maxY = bottom;
        }
    });
    const padding = 50;
    container.style.width = `${Math.max(maxX - minX + padding * 2, window.innerWidth)}px`;
    container.style.height = `${Math.max(maxY + padding * 2, window.innerHeight)}px`;
    container.style.left = `${-minX + padding}px`;
    container.style.position = 'relative';
    document.body.style.minWidth = `${maxX - minX + padding * 2}px`;
    document.body.style.minHeight = `${maxY + padding * 2}px`;
}

function updateConnections() {
    document.querySelectorAll('.connection').forEach(el => el.remove());
    connections = [];
    nodes.forEach(node => {
        if (node.parentId) {
            drawConnection(node.parentId, node.id);
        }
    });
}

function drawConnection(fromId, toId) {
    const svgNS = "http://www.w3.org/2000/svg";
    const svg = document.createElementNS(svgNS, "svg");
    svg.classList.add('connection');
    const line = document.createElementNS(svgNS, "line");
    svg.appendChild(line);
    document.getElementById('container').appendChild(svg);
    const fromEl = document.getElementById(fromId);
    const toEl = document.getElementById(toId);
    if (!fromEl || !toEl) {
        console.error('Connection elements not found:', fromId, toId);
        return;
    }
    const x1 = fromEl.offsetLeft + fromEl.offsetWidth / 2;
    const y1 = fromEl.offsetTop + fromEl.offsetHeight;
    const x2 = toEl.offsetLeft + toEl.offsetWidth / 2;
    const y2 = toEl.offsetTop;
    svg.style.left = '0';
    svg.style.top = '0';
    svg.style.width = '100%';
    svg.style.height = '100%';
    svg.style.position = 'absolute';
    svg.style.pointerEvents = 'none';
    line.setAttribute('x1', x1);
    line.setAttribute('y1', y1);
    line.setAttribute('x2', x2);
    line.setAttribute('y2', y2);
    const fromNode = nodes.find(n => n.id === fromId);
    const toNode = nodes.find(n => n.id === toId);
    if (toNode.type === NODE_TYPES.EVIDENCE) {
        line.setAttribute('stroke', '#9B59B6');
        line.setAttribute('stroke-width', '2');
    } else {
        let gradientFrom, gradientTo;
        if (fromNode.type === NODE_TYPES.STRATEGIC_GOAL) {
            gradientFrom = '#4CAF50';
            gradientTo = toNode.color;
        } else if (fromNode.type === NODE_TYPES.KPI) {
            gradientFrom = fromNode.color;
            gradientTo = '#FF9800';
        } else if (fromNode.type === NODE_TYPES.DELIVERABLE) {
            gradientFrom = toNode.color;
            gradientTo = toNode.color;
        }
        const gradientId = `grad-${fromId}-${toId}`;
        const defs = document.createElementNS(svgNS, 'defs');
        const gradient = document.createElementNS(svgNS, 'linearGradient');
        gradient.setAttribute('id', gradientId);
        gradient.setAttribute('x1', '0%');
        gradient.setAttribute('y1', '0%');
        gradient.setAttribute('x2', '0%');
        gradient.setAttribute('y2', '100%');
        const stop1 = document.createElementNS(svgNS, 'stop');
        stop1.setAttribute('offset', '0%');
        stop1.setAttribute('stop-color', gradientFrom);
        const stop2 = document.createElementNS(svgNS, 'stop');
        stop2.setAttribute('offset', '100%');
        stop2.setAttribute('stop-color', gradientTo);
        gradient.appendChild(stop1);
        gradient.appendChild(stop2);
        defs.appendChild(gradient);
        svg.appendChild(defs);
        line.setAttribute('stroke', `url(#${gradientId})`);
        line.setAttribute('stroke-width', '2');
    }
}

function escapeHtml(text) {
    if (!text || typeof text !== 'string') return '';
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, m => map[m]);
}


















// === Modal Functions ===
// Purpose: Manages help, inherit, and assignees modals.
// Explanation: Unchanged, but included for completeness.

function showHelpModal() {
    try {
        const helpModal = new bootstrap.Modal(document.getElementById('helpModal'), { backdrop: true, keyboard: true });
        helpModal.show();
    } catch (e) {
        console.error('Error showing Help Modal:', e);
    }
}

function hideHelpModal() {
    try {
        const helpModal = bootstrap.Modal.getInstance(document.getElementById('helpModal'));
        if (helpModal) {
            helpModal.hide();
        }
    } catch (e) {
        console.error('Error hiding Help Modal:', e);
    }
}

function openInheritModal() {
    try {
        const modal = new bootstrap.Modal(document.getElementById('inheritModal'), { backdrop: true, keyboard: true });
        modal.show();
    } catch (e) {
        console.error('Error showing Inherit Modal:', e);
    }
}

function openAssigneesModal() {
    try {
        const modal = new bootstrap.Modal(document.getElementById('assigneesModal'), { backdrop: true, keyboard: true });
        modal.show();
    } catch (e) {
        console.error('Error showing Assignees Modal:', e);
    }
}

// === Initialization ===
// Purpose: Sets up event listeners and initializes modals.
// Explanation: Unchanged, but included to ensure modal and theme persistence.

$(document).ready(function() {
    $('#employee-select').select2({
        theme: 'bootstrap-5',
        placeholder: "Search employees...",
        dropdownParent: $('#assigneesModal .modal-content'),
        width: '100%',
        closeOnSelect: false
    });

    $('#employee-inherit').select2({
        theme: 'bootstrap-5',
        placeholder: "Search employees...",
        dropdownParent: $('#inheritModal .modal-content'),
        width: '100%',
        closeOnSelect: false
    });

    $('.select2').css('z-index', '1056');

    const themeToggle = document.getElementById('themeToggle');
    const body = document.body;
    const savedTheme = localStorage.getItem('theme') || 'dark';
    body.classList.toggle('light-theme', savedTheme === 'light');
    themeToggle.textContent = savedTheme === 'dark' ? 'ðŸŒ‘' : 'â˜€ï¸';
    themeToggle.addEventListener('click', () => {
        const isLight = body.classList.contains('light-theme');
        body.classList.toggle('light-theme');
        const newTheme = isLight ? 'dark' : 'light';
        localStorage.setItem('theme', newTheme);
        themeToggle.textContent = newTheme === 'dark' ? 'ðŸŒ‘' : 'â˜€ï¸';
    });

    const helpModalEl = document.getElementById('helpModal');
    const assigneesModalEl = document.getElementById('assigneesModal');
    const inheritModalEl = document.getElementById('inheritModal');

    document.querySelector('.help-btn').addEventListener('click', showHelpModal);
    document.querySelector('.inherit-btn').addEventListener('click', openInheritModal);
    document.querySelector('.assignees-btn').addEventListener('click', openAssigneesModal);

    helpModalEl.querySelector('.btn-close').addEventListener('click', hideHelpModal);
    assigneesModalEl.querySelector('.btn-close').addEventListener('click', () => {
        const modal = bootstrap.Modal.getInstance(assigneesModalEl);
        if (modal) modal.hide();
    });
    inheritModalEl.querySelector('.btn-close').addEventListener('click', () => {
        const modal = bootstrap.Modal.getInstance(inheritModalEl);
        if (modal) modal.hide();
    });

    document.getElementById('saveAssignees').addEventListener('click', () => {
        const modal = bootstrap.Modal.getInstance(assigneesModalEl);
        if (modal) modal.hide();
    });
    document.getElementById('saveInherit').addEventListener('click', () => {
        const modal = bootstrap.Modal.getInstance(inheritModalEl);
        if (modal) modal.hide();
    });

    window.addEventListener('resize', repositionTree);

    document.getElementById('createStrategicGoal').addEventListener('click', createStrategicGoalForm);

    document.addEventListener('focusin', (e) => {
        if (e.target.closest('.node') || e.target.closest('.strategic-goal-form')) {
            body.classList.add('no-scroll');
        }
    });

    document.addEventListener('focusout', (e) => {
        if (!e.relatedTarget || (!e.relatedTarget.closest('.node') && !e.relatedTarget.closest('.strategic-goal-form'))) {
            body.classList.remove('no-scroll');
        }
    });

    ['helpModal', 'assigneesModal', 'inheritModal'].forEach(id => {
        const modal = document.getElementById(id);
        modal.addEventListener('show.bs.modal', () => console.log(`${id} is being shown`));
        modal.addEventListener('shown.bs.modal', () => console.log(`${id} has been shown`));
        modal.addEventListener('hide.bs.modal', () => console.log(`${id} is being hidden`));
        modal.addEventListener('hidden.bs.modal', () => console.log(`${id} has been hidden`));
    });
});

// === Employee Inherit Dropdowns ===
// Purpose: Populates employee inherit dropdowns.
// Explanation: Unchanged, as no password footer generation was found.

function populateEmployeeInheritDropdown() {
    const employeeCode = document.getElementById('employee-password').value;
    if (!employeeCode) {
        return;
    }
    fetch(`http://127.0.0.1:8002/fetch_common_employees/?reports_to_code=${encodeURIComponent(employeeCode)}`)
        .then(response => {
            if (!response.ok) throw new Error('Network response error');
            return response.json();
        })
        .then(data => {
            const employeeSelect = $('#employee-inherit');
            employeeSelect.empty();
            const uniqueEmployees = [...new Map(data.matched_employees.map(item => [item.employee_name, item])).values()];
            uniqueEmployees.forEach(employee => {
                const option = new Option(employee.employee_name, employee.employee_code);
                employeeSelect.append(option);
            });
            employeeSelect.trigger('change');
        })
        .catch(error => {
            console.error('Error fetching employee inherit dropdown values:', error);
        });
}

$('#employee-inherit').on('change', function() {
    const selectedEmployeeCode = $(this).val();
    document.getElementById('employee_code').value = selectedEmployeeCode;
});

document.getElementById('employee-password').addEventListener('programmatic-change', populateEmployeeInheritDropdown);
document.getElementById('employee-password').addEventListener('input', populateEmployeeInheritDropdown);

function populateEmployeeInheritDropdown1() {
    const employeeCode = document.getElementById('employee-password').value;
    if (!employeeCode) {
        return;
    }
    fetch(`http://127.0.0.1:8002/fetch_unmatched_employees/?reports_to_code=${encodeURIComponent(employeeCode)}`)
        .then(response => {
            if (!response.ok) throw new Error('Network response error');
            return response.json();
        })
        .then(data => {
            const employeeSelect = $('#select-inherit-1');
            employeeSelect.empty();
            const uniqueEmployees = [...new Map(data.unmatched_employees.map(item => [item.employee_name, item])).values()];
            uniqueEmployees.forEach(employee => {
                const option = new Option(employee.employee_name, employee.employee_code);
                employeeSelect.append(option);
            });
            employeeSelect.trigger('change');
        })
        .catch(error => {
            console.error('Error fetching employee inherit dropdown values:', error);
        });
}

$('#select-inherit-1').on('change', function() {
    const selectedEmployeeCodes = $(this).val();
    localStorage.setItem('selectedEmployeeCodes', JSON.stringify(selectedEmployeeCodes));
});

document.getElementById('employee-password').addEventListener('programmatic-change', populateEmployeeInheritDropdown1);
document.getElementById('employee-password').addEventListener('input', populateEmployeeInheritDropdown1);

const storedEmployeeCodes = localStorage.getItem('selectedEmployeeCodes');
if (storedEmployeeCodes) {
    $('#select-inherit-1').val(JSON.parse(storedEmployeeCodes)).trigger('change');
}






// === KPI, Deliverable, and Document Evidence Fetching ===
// Purpose: Fetches data for node dropdowns when Transversal or Departmental buttons are clicked.
// Explanation: Populates description-select dropdowns in KPI, Deliverable, and Document Evidence nodes using specified APIs.
// Fetch KPI Data
// Feedback Notification (updated to prevent superimposition)
function showFeedback(message, isSuccess) {
    // Remove any existing feedback elements
    const existingFeedback = document.querySelector('.feedback');
    if (existingFeedback) {
        existingFeedback.remove();
    }

    const feedbackEl = document.createElement('div');
    feedbackEl.className = `feedback ${isSuccess ? 'success' : 'error'}`;
    feedbackEl.innerHTML = message;
    feedbackEl.style.position = 'fixed';
    feedbackEl.style.top = '20px';
    feedbackEl.style.right = '20px';
    feedbackEl.style.padding = '10px';
    feedbackEl.style.backgroundColor = isSuccess ? '#4CAF50' : '#f44336';
    feedbackEl.style.color = 'white';
    feedbackEl.style.zIndex = '1000';
    feedbackEl.style.opacity = '1';
    feedbackEl.style.transition = 'opacity 0.5s';
    feedbackEl.setAttribute('role', 'alert'); // Added for accessibility
    document.body.appendChild(feedbackEl);
    setTimeout(() => {
        feedbackEl.style.opacity = '0';
        setTimeout(() => feedbackEl.remove(), 500);
    }, 3000);
}

// Fetch KPI Data
function fetchKPIData(nodeId, isTransversal = true) {
    // Clear existing success feedback for Departmental fetch to prevent false positives
    if (!isTransversal) {
        const existingSuccessFeedback = document.querySelector('.feedback.success');
        if (existingSuccessFeedback) {
            existingSuccessFeedback.remove();
        }
    }

    const departmentInput = document.getElementById('department_name');
    const companyCodeInput = document.getElementById('company_code');

    if (!departmentInput || !companyCodeInput) {
        console.error('Input elements not found:', { departmentInput, companyCodeInput });
        showFeedback('Input elements not found.', false);
        return;
    }

    const department = departmentInput.value.trim();
    const companyCode = companyCodeInput.value.trim();
    let url;

    console.log('fetchKPIData called:', { nodeId, isTransversal, department, companyCode }); // Debug log

    if (isTransversal) {
        if (!companyCode) {
            showFeedback('Company code is empty for Transversal fetch.', false);
            return;
        }
        url = `http://127.0.0.1:8002/fetch-kpis-transversal/?company_code=${encodeURIComponent(companyCode)}`;
    } else {
        if (!department) {
            showFeedback('Department name is empty for Departmental fetch.', false);
            return;
        }
        url = `http://127.0.0.1:8002/get_kpis/?department=${encodeURIComponent(department)}`;
    }

    const dropdown = document.querySelector(`#dropdown-${nodeId}`);
    if (!dropdown) {
        console.error('Dropdown not found:', `#dropdown-${nodeId}`);
        showFeedback('Dropdown element not found for KPI node.', false);
        return;
    }

    console.log('Fetching KPIs from:', url); // Debug log
    fetch(url)
        .then(response => {
            if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            return response.json();
        })
        .then(data => {
            console.log('KPI data received:', data); // Debug log
            // Normalize API response for KPIs
            const normalizedData = data.kpis ? data.kpis.map(item => ({
                value: item.kpi,
                description: item.description || ''
            })) : (Array.isArray(data) && typeof data[0] === 'string' ? data.map(item => ({ value: item, description: '' })) : data);
            updateDropdown(dropdown, normalizedData);
            showFeedback('KPIs fetched successfully.', true);
        })
        .catch(error => {
            console.error('Error fetching KPIs:', error);
            showFeedback(`Error fetching KPIs: ${error.message}`, false);
        });
}

// Fetch Deliverable Data
function fetchDeliverableData(nodeId, isTransversal = true) {
    // Clear existing success feedback for Departmental fetch to prevent false positives
    if (!isTransversal) {
        const existingSuccessFeedback = document.querySelector('.feedback.success');
        if (existingSuccessFeedback) {
            existingSuccessFeedback.remove();
        }
    }

    const departmentInput = document.getElementById('department_name');
    const companyCodeInput = document.getElementById('company_code');

    if (!departmentInput || !companyCodeInput) {
        console.error('Input elements not found:', { departmentInput, companyCodeInput });
        showFeedback('Input elements not found.', false);
        return;
    }

    const department = departmentInput.value.trim();
    const companyCode = companyCodeInput.value.trim();
    let url;

    console.log('fetchDeliverableData called:', { nodeId, isTransversal, department, companyCode }); // Debug log

    if (isTransversal) {
        if (!companyCode) {
            showFeedback('Company code is empty for Transversal fetch.', false);
            return;
        }
        url = `http://127.0.0.1:8002/fetch-deliverables-transversal/?company_code=${encodeURIComponent(companyCode)}`;
    } else {
        if (!department) {
            showFeedback('Department name is empty for Departmental fetch.', false);
            return;
        }
        url = `http://127.0.0.1:8002/get_deliverables/?department=${encodeURIComponent(department)}`;
    }

    const dropdown = document.querySelector(`#dropdown-${nodeId}`);
    if (!dropdown) {
        console.error('Dropdown not found:', `#dropdown-${nodeId}`);
        showFeedback('Dropdown element not found for Deliverable node.', false);
        return;
    }

    console.log('Fetching Deliverables from:', url); // Debug log
    fetch(url)
        .then(response => {
            if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            return response.json();
        })
        .then(data => {
            console.log('Deliverable data received:', data); // Debug log
            // Normalize API response for Deliverables (assuming similar structure)
            const normalizedData = data.deliverables ? data.deliverables.map(item => ({
                value: item.deliverable || item,
                description: item.description || ''
            })) : (Array.isArray(data) && typeof data[0] === 'string' ? data.map(item => ({ value: item, description: '' })) : data);
            updateDropdown(dropdown, normalizedData);
            showFeedback('Deliverables fetched successfully.', true);
        })
        .catch(error => {
            console.error('Error fetching Deliverables:', error);
            showFeedback(`Error fetching deliverables: ${error.message}`, false);
        });
}

// Fetch Document Evidence Data
function fetchDocumentEvidenceData(nodeId, isTransversal = true) {
    // Clear existing success feedback for Departmental fetch to prevent false positives
    if (!isTransversal) {
        const existingSuccessFeedback = document.querySelector('.feedback.success');
        if (existingSuccessFeedback) {
            existingSuccessFeedback.remove();
        }
    }

    const departmentInput = document.getElementById('department_name');
    const companyCodeInput = document.getElementById('company_code');

    if (!departmentInput || !companyCodeInput) {
        console.error('Input elements not found:', { departmentInput, companyCodeInput });
        showFeedback('Input elements not found.', false);
        return;
    }

    const department = departmentInput.value.trim();
    const companyCode = companyCodeInput.value.trim();
    let url;

    console.log('fetchDocumentEvidenceData called:', { nodeId, isTransversal, department, companyCode }); // Debug log

    if (isTransversal) {
        if (!companyCode) {
            showFeedback('Company code is empty for Transversal fetch.', false);
            return;
        }
        url = `http://127.0.0.1:8002/fetch-doc_evidence-transversal/?company_code=${encodeURIComponent(companyCode)}`;
    } else {
        if (!department) {
            showFeedback('Department name is empty for Departmental fetch.', false);
            return;
        }
        url = `http://127.0.0.1:8002/get_doc_evidence/?department=${encodeURIComponent(department)}`;
    }

    const dropdown = document.querySelector(`#dropdown-${nodeId}`);
    if (!dropdown) {
        console.error('Dropdown not found:', `#dropdown-${nodeId}`);
        showFeedback('Dropdown element not found for Document Evidence node.', false);
        return;
    }

    console.log('Fetching Document Evidence from:', url); // Debug log
    fetch(url)
        .then(response => {
            if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            return response.json();
        })
        .then(data => {
            console.log('Document Evidence data received:', data); // Debug log
            // Normalize API response for Document Evidence (assuming similar structure)
            const normalizedData = data.doc_evidence ? data.doc_evidence.map(item => ({
                value: item.evidence || item,
                description: item.description || ''
            })) : (Array.isArray(data) && typeof data[0] === 'string' ? data.map(item => ({ value: item, description: '' })) : data);
            updateDropdown(dropdown, normalizedData);
            showFeedback('Document Evidence fetched successfully.', true);
        })
        .catch(error => {
            console.error('Error fetching Document Evidence:', error);
            showFeedback(`Error fetching document evidence: ${error.message}`, false);
        });
}

// Update Dropdown with Fetched Data
function updateDropdown(dropdown, data) {
    if (!dropdown) {
        console.error('Dropdown element is null');
        showFeedback('Failed to update dropdown: element not found.', false);
        return;
    }

    try {
        // Store the current value if any
        const currentValue = $(dropdown).val();

        // Destroy existing Select2 instance if initialized
        if ($(dropdown).data('select2')) {
            $(dropdown).select2('destroy');
        }

        // Clear existing options
        dropdown.innerHTML = '<option value="" disabled selected>Select an option</option>';

        // Populate new options
        if (Array.isArray(data)) {
            data.forEach(item => {
                const value = item.value || item;
                const text = item.value || item;
                const option = new Option(text, value, false, currentValue === value);
                if (item.description) {
                    option.setAttribute('data-description', item.description);
                }
                dropdown.appendChild(option);
            });
        } else {
            console.warn('Data is not an array:', data);
            showFeedback('Invalid data format received from server.', false);
            return;
        }

        // Reinitialize Select2
        $(dropdown).select2({
            tags: true,
            width: '100%',
            placeholder: 'Enter or select description',
            allowClear: true,
            dropdownCssClass: 'select2-dropdown-custom'
        });

        // Restore the previous value if it exists in the new options
        if (currentValue && data.some(item => (item.value || item) === currentValue)) {
            $(dropdown).val(currentValue).trigger('change');
        } else {
            $(dropdown).val(null).trigger('change'); // Clear selection if no valid previous value
        }

        console.log('Dropdown updated with values:', data); // Debug log
    } catch (error) {
        console.error('Error updating dropdown:', error);
        showFeedback(`Failed to update dropdown: ${error.message}`, false);
    }
}
</script>
</body>
</html>